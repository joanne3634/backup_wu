$(function(){var a=0;$.fn.custform={init:function(){this.tables={};$("div[type=subtable]").each(function(){var e=$(this);var h=$(this).find("[formType=form]");var d;if(h.length>0){d=$(this).find("[formType=window]");}else{h=$(this).find("[formType=edit]");}e.data("row",$("<div></div>").append(h.clone()).html());h.css("display","none").html("");if(d){e.data("form","<form>"+$("<div></div>").append(d.clone()).html()+"</form>");d.remove();}var c=$(this).attr("tableName");$.fn.custform.tables[c]=e;var f=($(this).attr("right")=="w");var b=f||($(this).attr("right")=="r");$(this).find('[formType="newrow"]').each(function(){$(this).find("[name^=s]:visible").each(function(){$(this).attr("name",$(this).attr("name")+":"+a++);});if(f){$.fn.custform.addBind($(this),e);}});if(f){var g=$.ligerMenu({top:100,left:100,width:130,items:[{text:"添加",click:function(){$.fn.custform.add($(g.target).closest("div[type=subtable]"));}}]});$(this).find("[formType]:first").prev().bind("contextmenu",function(i){g.target=i.target;g.show({top:i.pageY,left:i.pageX});return false;});}if(!b){$(this).css("display","none");}});this.initUI();},initUI:function(c){var b;if(!c){c=$("body div[type=custform]");b="input,textarea";}else{b="input,textarea,.dicComboTree,.dicComboBox,.dicCombo";}$.metadata.setType("attr","validate");c.find(b).each(function(){if($(this).attr("ltype")=="text"){$(this).ligerTextBox({width:$(this).width()-2});}else{if($(this).attr("ltype")=="number"){$(this).ligerSpinner({width:$(this).width()-2});}else{if($(this).attr("ltype")=="date"){$(this).ligerDateEditor({width:$(this).width()-2});}else{if($(this).is(".dicComboTree,.dicComboBox,.dicCombo")){$(this).htDicCombo();}}}}});if(c.is("form")){c.data("validate",this.getValidate(c));}else{this.valid=this.getValidate(c.closest("form"));}},add:function(c,b){if(c.data("form")){this.openWin("添加",$(c.data("form")),c,b,function(i,h,g){var f=i.data("validate");if(!f.checkForm()){f.showErrors();return false;}else{var e={};var j=$('<div type="hidden"></div>');i.find("input[name], textarea[name]").each(function(){j.append($('<input type="hidden"/>').attr("name",$(this).attr("name")).val($(this).val()));e[$(this).attr("name")]=$(this).val();});var k=$(h.data("row"));k.append(j);k.find("[fieldName]").each(function(){var m=$(this).attr("fieldName");var l=e[m];if(!l){l="";}$(this).text(l);});$.fn.custform._add(h,k,g);f.showErrors();return true;}});}else{var d=$(c.data("row"));d.find("[name^=s]").each(function(){$(this).attr("name",$(this).attr("name")+":"+a++);});this._add(c,d,b);}},_add:function(d,b,c){if(c){$(c).before(b);}else{d.find("[formType]:last").after(b);}this.initUI(b);this.addBind(b,d);},addBind:function(e,c){var b=($.fn.custform.tables[c.attr("tableName")].data("form")!=null);var d=$.fn.custform.getMenu(b);e.bind("contextmenu",function(f){d.target=f.target;d.show({top:f.pageY,left:f.pageX});return false;});},edit:function(d,e){var b=d.attr("tableName");var c=$(this.tables[b].data("form"));c.find("[name]").each(function(){var f=e.find('[name="'+$(this).attr("name")+'"]').val();$(this).val(f);});c.data("row",e);this.openWin("编辑",c,d,null,function(i,h){var g=i.data("validate");if(!g.checkForm()){g.showErrors();}else{var f={};var k=i.data("row");var j=k.find("div[type=hidden]").empty();i.find("input[name], textarea[name]").each(function(){j.append($('<input type="hidden"/>').attr("name",$(this).attr("name")).val($(this).val()));f[$(this).attr("name")]=$(this).val();});$(k).find("[fieldName]").each(function(){var m=$(this).attr("fieldName");var l=f[m];if(!l){l="";}$(this).text(l);});g.showErrors();return true;}});},getValidate:function(b){return b.validate({debug:false,errorPlacement:function(c,d){if(d.hasClass("l-text-field")){d=d.parent();}d.addClass("validError");d.mouseover(function(){d.ligerTip({content:c.html(),appendIdTo:c});});d.mouseout(function(){c.ligerHideTip();});c.element=d;},success:function(c){c.element.removeClass("validError");c.element.unbind("mouseover");c.ligerHideTip();}});},validate:function(){return this.valid.checkForm();},showError:function(){this.valid.showErrors();},getData:function(){var b={tableId:$("#tableId").val(),tableName:$("#tableName").val(),fields:{}};$("input[name^=m], textarea[name^=m]").each(function(){var f=$(this).attr("name");b.fields[f.replace(/.*:/,"")]=$(this).val();});var c=[];$("div[type=subtable]").each(function(){var f={tableName:$(this).attr("tableName"),fields:[]};$(this).find("[formtype]:visible").each(function(){var g={};$(this).find("input,textarea").each(function(){var h=$(this).attr("name").split(":")[2];g[h]=$(this).val();});f.fields.push(g);});c.push(f);});var e=[];$("textarea[name^=opinion]").each(function(){e.push({name:$(this).attr("name").split(":")[1],value:$(this).val()});});var d={main:b,sub:c,opinion:e};return JSON2.stringify(d);},openWin:function(f,d,c,b,g){d.data("beforeElement",b);var e=d.ligerWindow({width:400,height:300,left:($(window).width()-400)/2,top:($(window).height()-300)/2,title:f,showMax:true,showToggle:true,onClose:true,showButton:true,buttons:[{text:"确定",handler:function(){var h=g(d,c,d.data("beforeElement"));if(h){e.close();}}}]});this.initUI(d);e.show();},getMenu:function(b){if((b&&this.menuWithEdit)||(!b&&this.menu)){return b?this.menuWithEdit:this.menu;}else{var d;var c=[{text:"在前面插入记录",click:function(){var f=$(d.target).closest("[formType]");var e=f.closest("div[type=subtable]");$.fn.custform.add(e,f);}},{text:"在后面插入记录",click:function(){var f=$(d.target).closest("[formType]");var e=f.closest("div[type=subtable]");f=f.next("[formType]:visible");if(f.length==0){f=null;}$.fn.custform.add(e,f);}},{line:true},{text:"编辑",click:function(){var f=$(d.target).closest("[formType]");var e=f.closest("div[type=subtable]");$.fn.custform.edit(e,f);}},{text:"删除此记录",click:function(){var e=$(d.target).closest("[formType]");e.remove();}},{line:true},{text:"向上移动",click:function(){var e=$(d.target).closest("[formType]");var f=e.prev("[formType]:visible");if(f.length>0){f.before(e);}}},{text:"向下移动",click:function(){var e=$(d.target).closest("[formType]");var f=e.next("[formType]:visible");if(f.length>0){f.after(e);}}}];if(!b){c.splice(3,1);}d=$.ligerMenu({top:100,left:100,width:130,items:c});if(b){this.menuWithEdit=d;}else{this.menu=d;}return d;}}};$.fn.custform.init();});