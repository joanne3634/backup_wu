if(typeof FormUtil=="undefined"){FormUtil={};}var onBeforeSelectTabItemCallBack=null;var onAfterSelectTabItemCallBack=null;FormUtil.initTab=function(){var a=$("#formTab").length;if(a>0){$("#formTab").ligerTab({onBeforeSelectTabItem:function(b){if(onBeforeSelectTabItemCallBack){return onBeforeSelectTabItemCallBack(b);}},onAfterSelectTabItem:function(b){FormUtil.changeTabStyle(b);if(onAfterSelectTabItemCallBack){onAfterSelectTabItemCallBack(b);}}});}};FormUtil.changeTabStyle=function(a){var b=$("div[tabid='"+a+"']");FormUtil.changeTabOfficeStyle(b);FormUtil.changeTabZoomStyle(b);};FormUtil.changeTabOfficeStyle=function(c){var a=$("div[name='menuBar']");var b=$("input[controltype='office']");if(a.length>0&&b.length>0){a.each(function(d){$(this).css("display","none");});$("div[name='menuBar']",c).each(function(d){$(this).css("display","block");});c.attr("style","");OfficePlugin.isTabItemOffice=false;}};FormUtil.changeTabZoomStyle=function(a){var b=$("input[controltype='pictureShow']");if(b.length>0){b.each(function(e){var d=$(this).attr("name");var c="div_"+d.replaceAll(":","_");$("#"+c).css("display","none");});$("input[controltype='pictureShow']",a).each(function(e){var d=$(this).attr("name");var c="div_"+d.replaceAll(":","_");$("#"+c).css("display","block");});if(PictureShowPlugin.browserName=="MSIE"){$("div.wrap_div",a).each(function(c){$(this).css("text-align","left");});}PictureShowPlugin.isTabItemZoom=false;}};FormUtil.initTabStyle=function(){var a=null;var b=$("#formTab").length;if(b>0){var a=null;$("div.l-tab-content-item").each(function(d){a=$(this).attr("tabid");if(typeof(a)!=undefined||a!=null||a!=""||a!="null"){return false;}});var c=$("div[tabid='"+a+"']");FormUtil.recursiveTabItemOffice(c);FormUtil.recursiveTabItemZoom(c);}};FormUtil.recursiveTabItemOffice=function(a){window.setTimeout(function(){if(OfficePlugin.isTabItemOffice){FormUtil.changeTabOfficeStyle(a);if(OfficePlugin.isTabItemOffice){FormUtil.recursiveTabItemOffice(a);}}},1500);};FormUtil.recursiveTabItemZoom=function(a){window.setTimeout(function(){if(PictureShowPlugin.isTabItemZoom){FormUtil.changeTabZoomStyle(a);if(PictureShowPlugin.isTabItemZoom){FormUtil.recursiveTabItemZoom(a);}}},1500);};FormUtil.initCalendar=function(){$("body").delegate("input.Wdate","click",function(){var a=$(this).attr("dateFmt");WdatePicker({el:this,dateFmt:a});});};FormUtil.initCommonDialog=function(){$("a.extend",$(".formTable")).each(function(){var extend=$(this);var jsonStr=extend.attr("dialog");if(jsonStr!=null&&"undefined"!=jsonStr.toLowerCase()&&jsonStr.length>2){var jsonObj=eval("("+jsonStr+")");var fileds=jsonObj.fields;for(var i=0;i<fileds.length;i++){var ds=$(".formTable [name$=':"+fileds[i].target+"']").not("[name^='s:']");if(ds.length<1){extend.remove();break;}else{var mark=false;ds.each(function(index){var right=$(this).attr("right");if(right=="r"||right=="rp"){extend.remove();mark=true;return false;}});if(mark){break;}}}}});$("body").delegate("[dialog]","click",function(){var obj=$(this);var dialogJson=obj.attr("dialog");var json=eval("("+dialogJson+")");var name=json.name;var fields=json.fields;var parentObj=obj.closest("[formtype]");var isGlobal=parentObj.length==0;var paramsValueString="";var queryArr=json.query;var isMain,preSelector,isReturn=false;if(!queryArr==false&&queryArr.length>0){for(var i=0;i<queryArr.length;i++){isMain=queryArr[i].isMain;if(isMain=="true"){preSelector=".formTable";}else{preSelector="div[type='subtable']";}$(preSelector+" :hidden[name$=':"+queryArr[i].id+"ID']").each(function(){if($(this).val()!=""){paramsValueString+=queryArr[i].name+"="+$(this).val()+"&";return false;}});if(paramsValueString.indexOf(queryArr[i].name)<0){$(preSelector+" [name$=':"+queryArr[i].id+"']").each(function(){var self=$(this);if(self.val()!=""){paramsValueString+=queryArr[i].name+"="+$(this).val()+"&";return false;}else{var selfClass=self.attr("class");if(!selfClass==false){if(selfClass.indexOf("validError")>=0){isReturn=true;$.ligerDialog.warn("请填写好--"+self.attr("lablename"),$lang.tip.msg);return false;}}}});}if(isReturn){return false;}}}CommonDialog(name,function(data){var len=data.length;for(var i=0;i<fields.length;i++){var json=fields[i];var src=json.src;var targets=json.target.split(","),target;while(target=targets.pop()){if(!target){return;}var filter="[name$=':"+target+"']";var targetObj=isGlobal?$(filter):$(filter,parentObj);if(len==undefined){targetObj.val(data[src]);targetObj.trigger("change");}else{for(var k=0;k<len;k++){var dataJson=data[k];if(json.data){json.data.push(dataJson[src]);}else{var tmp=[];tmp.push(dataJson[src]);json.data=tmp;}}targetObj.val(json.data.join(","));targetObj.trigger("change");}}}},paramsValueString);});};FormUtil.handSelector=function(){$("body").delegate("a.link.user","click",function(){FormUtil.Selector($(this),1);});$("body").delegate("a.link.users","click",function(){FormUtil.Selector($(this),2);});$("body").delegate("a.link.role","click",function(){FormUtil.Selector($(this),3);});$("body").delegate("a.link.roles","click",function(){FormUtil.Selector($(this),4);});$("body").delegate("a.link.org","click",function(){FormUtil.Selector($(this),5);});$("body").delegate("a.link.orgs","click",function(){FormUtil.Selector($(this),6);});$("body").delegate("a.link.position","click",function(){FormUtil.Selector($(this),7);});$("body").delegate("a.link.positions","click",function(){FormUtil.Selector($(this),8);});$("body").delegate("a.link.actInsts","click",function(){FormUtil.Selector($(this),9);});$("body").delegate("a.link.reset","click",function(){var f=$(this);var g=f.attr("name");var d=f.parent();var c="input[name='"+g+"ID']";var e="input[name='"+g+"']";var a=$(c,d);var b=$(e,d);a.val("");b.val("");b.removeAttr("refid");});};FormUtil.Selector=function(f,b){var a=f.attr("name"),e=f.parent(),p="input[name='"+a+"ID']",s="input[name='"+a+"']",r="a[name='"+a+"ID']",k=$(p,e),d=$(s,e),c=$(r,e),q=k.val(),l=k.val(),g=d.val(),t=[];if(l){var m=l.split(","),h=g.split(","),j=m.length;for(var n=0;n<j;n++){t.push({id:m[n],name:h[n]});}}switch(b){case 1:UserDialog({isSingle:true,selectUsers:t,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 2:UserDialog({isSingle:false,selectUsers:t,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 3:RoleDialog({isSingle:true,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 4:RoleDialog({arguments:t,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 5:OrgDialog({isSingle:true,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 6:OrgDialog({arguments:t,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 7:PosDialog({isSingle:true,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 8:PosDialog({arguments:t,callback:function(i,u){if(k.length>0){k.val(i);}d.val(u);}});break;case 9:var o=$("[name='defId']").val();if(!o){o=0;}ActInstDialog({defId:o,isSingle:2,arguments:t,callback:function(i){if(!i){return;}if(k.length>0){k.val(i.ids);}d.val(i.names);d.attr("refid",i.ids);}});}d.trigger("blur");if(k.val()!=q){k.trigger("change");d.trigger("change");}};FormUtil.InitMathfunction=function(a){if(a){$("input",a).trigger("change");}else{$("input").live("change",FormMath.doMath);}};FormUtil.getTargetVal=function(b,d){var c=d.attr("type");if(d.is("select")){var e=d.find("option:selected").val();if(e==b.value){return true;}return false;}else{if(c=="radio"||c=="checkbox"){var a=false;d.each(function(){var f=$(this),g=f.attr("checked"),h=f.val();if(g&&b.value.indexOf(h)>-1){a=true;}});return a;}else{return false;}}};FormUtil.validHasChange=function(e){var a=true;for(var b=0,f;f=e[b++];){var d=FormUtil.getTargetObj(f.key);if(!FormUtil.getTargetVal(f,d)){a=false;}}return a;};FormUtil.doChange=function(e,b){for(var a=0,d;d=b[a++];){if(!$.isEmpty(d.fieldtype)&&d.fieldtype=="1"){FormUtil.doChangeTable(e,d);}else{FormUtil.doChangeField(e,d);}}};FormUtil.preChange=function(e,m,o){var h=[],f=$changeObj.data("formtrace");for(var g=0,l;l=e[g++];){h.push(l.key);if(f){for(var d=0,a;a=m[d++];){var b=f[a.key+"_"+a.type];if(b){var k=null;if(!$.isEmpty(a.fieldtype)&&a.fieldtype=="1"){k=$("div[type='subtable'][tablename='"+a.key+"']");}else{k=FormUtil.getTargetObj(a.key);}b.call(k,a);k.trigger("blur");delete f[a.key+"_"+a.type];}}}}if(o){$changeFunc.push({choiceKey:h,changes:m});}};FormUtil.isAttachment=function(b){var a=b.attr("controltype");if(!$.isEmpty(a)&&a=="attachment"){return true;}else{return false;}};var $fieldChange={1:function(b){var a=$(this).val("");if(FormUtil.isAttachment(a)){a.parent("div").hide();}else{a.hide();a.parents("label").hide();}},2:function(b){var a=$(this);if(FormUtil.isAttachment(a)){a.parent("div").show();}else{a.show();a.parents("label").show();}},3:function(b){var a=$(this);if(a.is("a")){return;}if(FormUtil.isAttachment(a)){a.siblings("a[field='"+b.key+"']").hide();a.siblings(".attachement").find("a.cancel").each(function(){$(this).hide();});}else{a.attr("disabled",true);}},4:function(b){var a=$(this);if(a.is("a")){return;}if(FormUtil.isAttachment(a)){a.siblings("a[field='"+b.key+"']").show();a.siblings(".attachement").find("a.cancel").each(function(){$(this).show();});}else{a.removeAttr("disabled");}},5:function(c){var self=$(this),validate=self.attr("validate");if(self.is("a")){return;}if(FormUtil.isAttachment(self)){self.siblings("a.selectFile").addClass("validError");self.parent().attr("right","b");}else{self.addClass("validError");if(!validate){self.attr("validate","{required:true}");}else{validate=eval("("+validate+")");if(!validate.required){validate.required=true;self.attr("validate",JSON2.stringify(validate));}}if(!$.isEmpty(self.val())){self.removeClass("validError");}else{if(self.hasClass("Wdate")){self.css("border","1px solid red");}}}},6:function(c){var self=$(this),validate=self.attr("validate");if(self.is("a")){return;}if(FormUtil.isAttachment(self)){self.siblings("a.selectFile").removeClass("validError");self.parent().attr("right","w");}else{if(validate){validate=eval("("+validate+")");if(validate.required){delete validate.required;self.attr("validate",JSON2.stringify(validate));}self.removeClass("validError");if(self.hasClass("Wdate")){self.css("border","1px solid #999999");}}}},7:function(b){var a=$(this);if(a.is("a")){return;}if(FormUtil.isAttachment(a)){a.siblings(".attachement").html("");}if(a.attr("type")=="checkbox"||a.attr("type")=="radio"){a.removeAttr("checked");}$(this).val("");}};FormUtil.getTargetObj=function(a){if(!$changeObj){return $("[name='"+a+"']");}var c=$changeObj.parents("[formtype]"),b=null;if(c&&c.length>0){b=$("[name='"+a+"']",c);}else{b=$("[name='"+a+"']");}return b;};FormUtil.doChangeField=function(i,h){var e=FormUtil.getTargetObj(h.key);if(!e||e.length==0){return;}var a=h.type,b=null;if(a!="8"){var g=$fieldChange[a];if(a%2){b=$fieldChange[++a];}else{b=$fieldChange[--a];}e.each(function(){g.call(this,h);});}else{var f=h.cascade.reduce,d="";e.each(function(){var s=$(this),r=s.attr("type");if($(this).is("a")){return;}if(r=="radio"||r=="checkbox"){var m=s.parents("span");for(var o=0,p;p=f[o++];){if(s.val()==p.id){m.remove();}}}else{isSelect=true;d=s.html();var u=s.find("option");for(var o=0,p;p=f[o++];){for(var l=0,k;k=u[l++];){var q=$(k);if(!q.val()){continue;}if(q.val()==p.id){q.remove();}}}}});FormUtil.putInFormTrace(i,"tracedata",h.key,d);b=function(k){var j=$changeObj.data("tracedata");if(j){d=j[k.key];$(this).each(function(){var c=$(this).val();$(this).html(d).val(c).trigger("change");});delete j[k.key];}};}FormUtil.putInFormTrace(i,"formtrace",h.key+"_"+h.type,b);e.trigger("blur");};FormUtil.putInFormTrace=function(h,a,d,f){for(var b=0,g;g=h[b++];){var c=FormUtil.getTargetObj(g);if(!c){continue;}var e=c.data(a);if(!e){e={};e[d]=f;c.data(a,e);}else{e[d]=f;}}};var $tableChange={1:function(){var a=$(this);a.hide();},2:function(){var a=$(this);a.show();},3:function(){var a=$(this);$("a.add",a).hide();a.find("[formType]").prev().unbind("contextmenu");$("td",a).find("input,select,textarea").attr("disabled","disabled");$("td",a).find("a").hide();},4:function(){var a=$(this);$("a.add",a).show();$("td",a).find("input,select,textarea").removeAttr("disabled","disabled");$("td",a).find("a").show();},5:function(){var a=$(this);var b=a.attr("right");a.attr("right","b");a.attr("yright",b);},6:function(){var a=$(this);var b=a.attr("yright");a.attr("right",b?"w":b);},7:function(){var a=$(this);$(":text,select",a).each(function(){$(this).val("");});$("textarea",a).each(function(){var b=$(this);if(FormUtil.isAttachment(b)){b.siblings(".attachement").html("");}b.val("");});$("input[type='radio']",a).each(function(){$(this).removeAttr("checked");});$("input[type='checkbox']",a).each(function(){$(this).removeAttr("checked");});}};FormUtil.doChangeTable=function(f,e){var b=$("div[type='subtable'][tablename='"+e.key+"']"),a=e.type;var d=$tableChange[a];if(a%2){traceCall=$tableChange[++a];}else{traceCall=$tableChange[--a];}b.each(function(){d.call(this,e);});FormUtil.putInFormTrace(f,"formtrace",e.key+"_"+e.type,traceCall);};var $changeObj=null,$changeFunc=[],$changeNoChoise=[];FormUtil.ChangeNoChoise=function(){FormUtil.doChange([],$changeNoChoise);};FormUtil.InitGangedSet=function(d){$changeNoChoise=[];for(var i=0,c;c=d[i++];){var choisefield=eval("("+c.choisefield+")"),changefield=eval("("+c.changefield+")");if(choisefield&&choisefield.length==0){$changeNoChoise=$changeNoChoise.concat(changefield);}for(var j=0,m;m=choisefield[j++];){var changeObj=$("*[name='"+m.key+"']");changeObj.die("change").live("change",function(e){$changeFunc=[];$changeObj=$(e.target);var key=$changeObj.attr("name");if(!key){return;}for(var x=0,n;n=d[x++];){if(n.choisefield.indexOf(key)>-1){var curChoise=eval("("+n.choisefield+")"),r=FormUtil.validHasChange(curChoise);FormUtil.preChange(curChoise,eval("("+n.changefield+")"),r);}}if($changeFunc.length>0){for(var y=0,o;o=$changeFunc[y++];){FormUtil.doChange(o.choiceKey,o.changes);}}});changeObj.trigger("change");}}FormUtil.ChangeNoChoise();};FormUtil.triggerChoice=function(a){$("[name]",a).each(function(){var e=$(this),c=e.attr("name"),d=FormUtil.findWithChange(c);if(d){var b=$("[name='"+d+"']"),f=b.val();b.trigger("change");}});};FormUtil.findWithChange=function(name){if(typeof bpmGangedSets=="undefined"){return null;}for(var i=0,c;c=bpmGangedSets[i++];){var choisefield=eval("("+c.choisefield+")"),changefield=eval("("+c.changefield+")");if(choisefield&&choisefield.length==0){return null;}for(var j=0,m;m=changefield[j++];){if(m.key==name){return choisefield[0]["key"];}}}};FormUtil.initCommonQuery=function(){$("[query]").live("keyup change",function(event){var obj=$(this),queryJson=obj.attr("query"),json=eval("("+queryJson+")"),evt=json.evt,next=obj.next();if(evt.key!=event.type){return;}if("carriage_return"==evt.name&&event.keyCode!=evt.code){return;}var obj=$(this);var queryJson=obj.attr("query");var json=eval("("+queryJson+")");var name=json.name;var cond=json.cond;var value=obj.val();if(next&&next.length>0){if(next.hasClass("link")&&next[0].tagName=="A"){value=$("input[name='"+obj.attr("name")+"ID']").val();}}if(!value){return;}var fields=json.fields;var parentObj=obj.closest("[formtype]");var isGlobal=parentObj.length==0;var querydataStr="{"+cond+':"'+value+'"}';var queryCond={alias:name,querydata:querydataStr,page:1,pagesize:10};DoQuery(queryCond,function(data){if(data.errors){return;}for(var i=0;i<fields.length;i++){var json=fields[i];var src=json.src;var targets=json.target;var target;while(target=targets.pop()){if(!target){return;}var filter="[name$=':"+target+"']";var targetObj=isGlobal?$(filter):$(filter,parentObj);if(data.list.length<1){targetObj.val("");continue;}var dataArr=[];for(var k=0;k<data.list.length;k++){var dataJson=data.list[k];if(dataArr){dataArr.push(dataJson[src.toLowerCase()]);}else{var tmp=[];tmp.push(dataJson[src.toLowerCase()]);dataArr=tmp;}}targetObj.val(dataArr.join(","));targetObj.trigger("change").trigger("blur");}}});}).trigger("change");};FormUtil.initExtLink=function(){$("body").delegate("a[linktype]","click",function(){var i=$(this).attr("linktype");if(!i){return;}var h=parseInt(i);var b="dialogWidth:800px;dialogHeight:600px;help:0;status:1;scroll:1;center:1";switch(h){case 4:case 8:var e=$(this).attr("refid");a=__ctx+"/platform/system/sysUser/getByUserId.ht?canReturn=2&userId="+e;window.showModalDialog(a,"",b);break;case 5:case 17:var d=$(this).attr("refid");ShowExeInfo.showRole(d);break;case 6:case 18:var c=$(this).attr("refid");ShowExeInfo.showOrg(c);break;case 7:case 19:var f=$(this).attr("refid");ShowExeInfo.showPos(f);break;case 20:var j=$(this).attr("refid");var a=__ctx+"/platform/bpm/processRun/info.ht?isOpenDialog=1&link=1&runId="+j;var g="dialogWidth:900px;dialogHeight:700px;help:0;status:1;scroll:1;center:1";window.showModalDialog(a,"",g);break;}});};