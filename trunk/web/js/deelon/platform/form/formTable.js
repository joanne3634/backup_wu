Namespace.register("com.deelon.platform.form");$(function(){var a=[{key:"varchar",value:"文字"},{key:"number",value:"数字"},{key:"date",value:"日期"},{key:"clob",value:"大文本"}];var i={};$(a).each(function(k,l){i[l.key]=l.value;});var j=[{key:"1",value:"单行文本框"},{key:"2",value:"多行文本框"},{key:"10",value:"富文本框"},{key:"3",value:"数据字典"},{key:"4",value:"人员选择器(单选)"},{key:"8",value:"人员选择器(多选)"},{key:"5",value:"角色选择器"},{key:"6",value:"组织选择器"},{key:"7",value:"岗位选择器"},{key:"9",value:"文件上传"}];var b=[{key:"0",value:"表单输入"},{key:"1",value:"脚本运算(显示)"},{key:"2",value:"脚本运算(不显示)"},{key:"3",value:"流水号"}];var g='<option value="#value">#text</option>';var h='<input name="#name" type="checkbox" value="1" #checked/>';com.deelon.platform.form.TableManager=function(l,k){this.ids=l.id;this.table=l.data.table;this.fieldList=new c(l,k);this.fieldProperty=new e(l,this.fieldList);this.validate=function(){return this.fieldProperty.validateAll();},this.showAllError=function(){this.fieldProperty.showAllError();},this.getData=function(){var n=$("#"+this.ids.tablePropertyId);var v={tableId:n.find(":hidden[name=tableId]").val(),tableName:n.find(":text[name=tableName]").val(),tableDesc:n.find(":text[name=tableDesc]").val(),versionNo:n.find(":hidden[name=versionNo]").val(),isPublished:n.find(":hidden[name=isPublished]").val(),isMain:n.find(":radio[name=isMain][checked]").val(),mainTableId:n.find("select[name=mainTableId]").closest("td").is(":visible")?n.find("select[name=mainTableId]").val():"",action:$("#action").val()};tableJson=$.extend({},tableJson,this.table);var w=JSON2.stringify(tableJson);var s="[";for(var r=0;r<this.fieldList.fields.length;r++){var t=this.fieldList.fields[r];s+=JSON2.stringify(t)+",";if(t.controlType=="4"||t.controlType=="5"||t.controlType=="6"||t.controlType=="7"||t.controlType=="8"){var o=t.fieldName+"ID";var m=false;for(var q=0;q<this.fieldList.hiddenFields.length;q++){if(this.fieldList.hiddenFields[q].fieldName==o){this.fieldList.hiddenFields[q].charLen=t.charLen;this.fieldList.hiddenFields[q].hasOwner=true;m=true;break;}}if(!m){var u=$.extend(true,{},t);this.fieldList.hiddenFields.push(u);u.fieldName=o;u.isHidden=1;u.fieldId=null;u.hasOwner=true;for(var q=0;q<this.fieldList.hiddenFields.length;q++){if(t.originalName&&this.fieldList.hiddenFields[q].fieldName==t.originalName+"ID"){u.originalName=t.originalName+"ID";}}}}}for(var r=0;r<this.fieldList.hiddenFields.length;r++){if(this.fieldList.hiddenFields[r].hasOwner||this.fieldList.hiddenFields[r].originalName){s+=JSON2.stringify(this.fieldList.hiddenFields[r])+",";}}s+="]";return{table:w,fields:s};};};function c(n,o){var q=n.data;this.index=-1;this.fields=[];this.deletedFields=[];this.allFields=[];this.hiddenFields=[];if(q&&q.fieldList){var k=q.fieldList;for(var m=0;m<k.length;m++){if(k[m].isHidden=="1"){this.hiddenFields.push(k[m]);}else{if(k[m].isDeleted=="0"){this.fields.push(k[m]);}else{this.deletedFields.push(k[m]);}}this.allFields.push(jQuery.extend(true,[],k[m]));}}this.layout=o;this.ids=n.id;var l=this;setTimeout(function(){l.init();l.showFieldList();},1);this.setFieldProperty=function(r){this.fieldProperty=r;return this;},this.selectField=function(r){if(r==null){r=-1;}if(r>-1){if(this.layout.isBottomCollapse){this.layout.setBottomCollapse(false);}}else{this.layout.setBottomCollapse(true);this.fieldProperty.resetForm();}if(this.index!=r){if(this.index!=-1&&!this.fieldProperty.validate()){this.fieldProperty.showError();return false;}this.index=r;$("#"+this.ids.fieldListId+" tr").removeClass("even");if(r>-1){$("#r"+r).addClass("even");this.fieldProperty.showDetail();}}return true;},this.setEditorTo=function(x,v){if(!$(x).attr("name")||$(x).find(":checkbox").length>0||(!this.fields[v].isnew&&$(x).is("[name=fieldType]"))){return;}else{if($(x).is(":checkbox")){if($(x).attr("checked")){$("#"+this.ids.fieldPropertyId+" [name="+$(x).attr("name")+"]").attr("checked","checked").change();}else{$("#"+this.ids.fieldPropertyId+" [name="+$(x).attr("name")+"]").removeAttr("checked").change();}return;}}var u=$(x).attr("name");var t=$("#"+u+"input");var s=$(x).position();var w=this.fields[v][u];if(t.is(":text")){w=$(x).text();}var r=$("#"+this.ids.centerId);t.css("left",s.left+r.scrollLeft()+1).css("top",s.top+r.scrollTop()+1).css("width",$(x).width()-2).css("height",$(x).height()-2).css("display","").val(w);setTimeout(function(){t.focus();},1);},this.showFieldList=function(){$("#"+this.ids.fieldListId+" tr:gt(0)").remove();var s='<tr id="r#id">';$("#"+this.ids.fieldListId+" tr:eq(0) th").each(function(){s+='<td name="'+$(this).attr("name")+'">#'+$(this).attr("name")+"</td>";});s+="</tr>";var r=this;$(this.fields).each(function(t,v){var u=s.replace("#id",t).replace("#lineNO",t+1);$(u).find("[name]").each(function(){var w=$(this).attr("name");u=u.replace("#"+w,r.getHtml(w,v[w],v));});$("#"+r.ids.fieldListId).append(u);});this.index=-1;this.reset();},this.moveupField=function(){if(this.index>0){var r=this.index-1;this.fieldManager.moveField(this.index,r);this.showFieldList();$("#"+this.ids.fieldListId+" #r"+r+" td:last").click();}},this.movedownField=function(){if(this.index>-1&&this.index<this.fields.length-1){var r=this.index+1;this.fieldManager.moveField(this.index,r);this.showFieldList();$("#"+this.ids.fieldListId+" #r"+r+" td:last").click();}},this.addField=function(){if(this.index!=-1&&!this.fieldProperty.validate()){this.fieldProperty.showError();return;}this.fieldManager.addField();this.showFieldList();$("#"+this.ids.fieldListId+" tr:last td[name]:eq(1)").click();var r=$("#"+this.ids.centerId);r.scrollTop(r.height());},this.delField=function(){if(this.index>-1){this.fieldManager.delField(this.index);var r=this.index;if(!(r<this.fields.length)){r--;}this.showFieldList();this.selectField(r);}else{$.ligerMsg.info("请先选择字段");}},this.backHistory=function(){this.historyManager.backHistory();},this.forwardHistory=function(){this.historyManager.forwardHistory();},this.updToolBar=function(){if(this.ids.backHistoryId){$("#"+this.ids.backHistoryId).html($("#"+this.ids.backHistoryId).html().replace(/\(\d+\)/g,"("+this.historyManager.currHistory+")"));}if(this.ids.forwardHistoryId){$("#"+this.ids.forwardHistoryId).html($("#"+this.ids.forwardHistoryId).html().replace(/\(\d+\)/g,"("+(this.historyManager.historys.length-this.historyManager.currHistory-1)+")"));}},this.getHtml=function(s,u,v){var t="";if(s=="fieldType"){t=i[u];if(u=="varchar"){t+="("+v.charLen+")";if(v.valueFrom==0){if(v.controlType==1||v.controlType==2){t+=",验证:"+(v.validRule==""?"无":v.validRule);}else{if(v.controlType==3){t+=",数据字典:"+this.fieldProperty.dictMap[v.dictType];}}}else{if(v.valueFrom==1||v.valueFrom==2){t+=",脚本运算";}else{if(v.valueFrom==3){t+=",流水号";}}}}else{if(u=="number"){t+="("+v.intLen+","+v.decimalLen+")";}}}else{if(s=="isRequired"||s=="isList"||s=="isQuery"||s=="isDeleted"||s=="isFlowVar"){var r=(u=="1"?"checked":"");t=h.replace("#name",s).replace("#checked",r);}else{t=u;}}return t;},this.reset=function(){var r=this;$("#"+this.ids.fieldListId+" td").unbind("click");$("#"+this.ids.fieldListId+" td, #"+this.ids.fieldListId+" :checkbox").click(function(){var t=parseInt($(this).parents("tr").attr("id").replace("r",""));var s=r.selectField(t);if(!s){return false;}r.setEditorTo(this,t);});},this.init=function(){var r=this;if(this.ids.addFieldId){$("#"+this.ids.addFieldId).click(function(){r.addField();});}if(this.ids.backHistoryId){$("#"+this.ids.backHistoryId).click(function(){r.backHistory();});}if(this.ids.forwardHistoryId){$("#"+this.ids.forwardHistoryId).click(function(){r.forwardHistory();});}if(this.ids.moveupFieldId){$("#"+this.ids.moveupFieldId).click(function(){r.moveupField();});}if(this.ids.movedownFieldId){$("#"+this.ids.movedownFieldId).click(function(){r.movedownField();});}if(this.ids.delFieldId){$("#"+this.ids.delFieldId).click(function(){r.delField();});}};}function e(m,k){var n=m.data;this.valid=null;this.tablevalid=null;this.table=n.table;this.allUnpublishedVersionTable=n.allUnpublishedVersionTable;if(n.usableMainTables){this.usableMainTables=n.usableMainTables;}else{this.usableMainTables=[];for(var l=0;l<this.allUnpublishedVersionTable.length;l++){if(this.allUnpublishedVersionTable[l].isMain==1){this.usableMainTables.push(this.allUnpublishedVersionTable[l]);}}}this.dictList=n.dictList;this.dictMap={};for(var l=0;l<this.dictList.length;l++){this.dictMap[this.dictList[l].nodeKey]=this.dictList[l].typeName;}this.validRuleList=n.validRuleList;this.identityList=n.identityList;this.fieldList=k;this.ids=m.id;this.fieldManager=new d(k,n);k.setFieldProperty(this);var o=this;setTimeout(function(){o.init();},1);this.setFieldList=function(q){this.fieldList=q;return this;},this.validate=function(){return this.valid.checkForm();},this.validateAll=function(){var q=true;if(!this.valid.checkForm()){q=false;}if(!this.tablevalid.checkForm()){q=false;}return q;},this.showError=function(){this.valid.showErrors();var s=this.valid.errorList;var r="请先处理当前的错误：";for(var q=0;q<s.length;q++){r+='<font color="red"><p>'+s[q].message+"</p></font>";}$.ligerMsg.info(r);},this.showAllError=function(){this.valid.showErrors();this.tablevalid.showErrors();var s=this.tablevalid.errorList;s=s.concat(this.valid.errorList);var r="请先处理当前的错误：";for(var q=0;q<s.length;q++){r+='<font color="red"><p>'+s[q].message+"</p></font>";}$.ligerMsg.info(r);},this.resetForm=function(){this.valid.resetForm();},this.showDetail=function(){this.resetForm();var r=$("#"+this.ids.fieldPropertyId);var s=this.fieldList.fields[this.fieldList.index];for(p in s){var q=r.find("[name="+p+"]");if(q.is(":checkbox")){if(q.val()==s[p]){q.attr("checked","checked");}else{q.removeAttr("checked");}}else{q.val(s[p]);}}this.changeDisplay();},this.setControlByType=function(q){var r=$("#"+this.ids.fieldPropertyId);var s=r.find("select[name=controlType]");s.empty();if(q=="varchar"){$(j).each(function(t,v){var u=g.replaceAll("#value",v.key).replace("#text",v.value);if(v.key!="10"){s.append(u);}});}else{if(q=="clob"){$(j).each(function(t,v){var u=g.replaceAll("#value",v.key).replace("#text",v.value);if(v.key=="10"||v.key=="2"){s.append(u);}});}}};this.changeDisplay=function(t){var u=$("#"+this.ids.fieldPropertyId);var q=u.find("select[name=fieldType]").val();var s=u.find("select[name=valueFrom]").val();var v=u.find("select[name=controlType]").val();if(!this.fieldList.fields[this.fieldList.index].isnew){u.find("select[name=fieldType]").attr("disabled","disabled");}else{u.find("select[name=fieldType]").removeAttr("disabled");}if(q=="varchar"){u.find("input[name=charLen]").closest("tr").css("display","");u.find("input[name=intLen]").closest("tr").css("display","none");}else{if(q=="number"){u.find("input[name=charLen]").closest("tr").css("display","none");u.find("input[name=intLen]").closest("tr").css("display","");}else{if(q=="date"){u.find("input[name=charLen]").closest("tr").css("display","none");u.find("input[name=intLen]").closest("tr").css("display","none");}else{if(q=="clob"){u.find("input[name=charLen]").closest("tr").css("display","none");u.find("input[name=intLen]").closest("tr").css("display","none");}}}}if(t!=undefined){var r=t.currentTarget.name;if(r=="fieldType"){this.setControlByType(q);}}if(q=="varchar"&&s=="0"||q=="clob"){u.find("select[name=controlType]").closest("tr").css("display","");}else{u.find("select[name=controlType]").closest("tr").css("display","none");}if(q=="varchar"&&s=="0"&&(v=="1"||v=="2")){u.find("select[name=validRule]").closest("tr").css("display","");}else{u.find("select[name=validRule]").closest("tr").css("display","none");}if(q=="varchar"&&s=="0"&&v=="3"){u.find("select[name=dictType]").closest("tr").css("display","");}else{u.find("select[name=dictType]").closest("tr").css("display","none");}if(s=="1"||s=="2"){u.find("textarea[name=script]").closest("tr").css("display","");}else{u.find("textarea[name=script]").closest("tr").css("display","none");}if(s=="3"){u.find("select[name=identity]").closest("tr").css("display","");}else{u.find("select[name=identity]").closest("tr").css("display","none");}},this.init=function(){var t=this;var q=this.fieldList;$("#"+this.ids.fieldPropertyId+" input, #"+this.ids.fieldPropertyId+" select, #"+this.ids.fieldPropertyId+" textarea").change(function(){var w=$(this).attr("name");if(q.index>-1){var z=$("#r"+q.index).find("[name="+w+"]");if($(this).is(":checkbox")){if($(this).attr("checked")){z.children(":checkbox").attr("checked","checked");}else{z.children(":checkbox").removeAttr("checked");}}if(t.valid.element(this)){if($(this).is("[name=fieldName]")){$("#"+t.ids.fieldPropertyId+" select[name=fieldType]").removeAttr("disabled");for(var x=0;x<q.allFields.length;x++){if($(this).val().toUpperCase()==q.allFields[x].fieldName.toUpperCase()){var v=this;$.ligerDialog.confirm($(v).val()+"在历史版本中已经存在,系统将会导入进来,并且数据类型不可更改,是否使用"+$(v).val()+"?","提示信息",function(A){if(A){z.html($(v).val());t.fieldManager.replaceField(q.index,q.allFields[x]);q.showFieldList();q.selectField(q.fields.length-1);}else{$(v).val(q.fields[q.index].fieldName);}});return;}}}var y=$(this).val();if($(this).is(":checkbox")&&!$(this).attr("checked")){y="0";}t.fieldManager.updField(q.fields[q.index],w,y);}if(!$(this).is(":checkbox")){z.html(q.getHtml(w,$(this).val(),q.fields[q.index]));$("#r"+q.index).find("[name=fieldType]").html(q.getHtml("fieldType",q.fields[q.index].fieldType,q.fields[q.index]));}}});$("#"+this.ids.fieldPropertyId+" select[name=fieldType], #"+this.ids.fieldPropertyId+" select[name=valueFrom], #"+this.ids.fieldPropertyId+" select[name=controlType]").change(function(v){t.changeDisplay(v);});var u=$("#"+this.ids.fieldPropertyId);$(this.dictList).each(function(v,x){var w=g.replace("#value",x.nodeKey).replace("#text",x.typeName);u.find("select[name=dictType]").append(w);});$(a).each(function(v,x){var w=g.replaceAll("#value",x.key).replace("#text",x.value);u.find("select[name=fieldType]").append(w);});$(this.validRuleList).each(function(v,x){var w=g.replaceAll("#value",x.name).replace("#text",x.name);u.find("select[name=validRule]").append(w);});$(b).each(function(v,x){var w=g.replaceAll("#value",x.key).replace("#text",x.value);u.find("select[name=valueFrom]").append(w);});$(j).each(function(v,x){var w=g.replaceAll("#value",x.key).replace("#text",x.value);u.find("select[name=controlType]").append(w);});$(this.identityList).each(function(v,x){var w=g.replaceAll("#value",x.alias).replace("#text",x.name);u.find("select[name=identity]").append(w);});$("#"+this.ids.fieldPropertyId+" :text, #"+this.ids.fieldPropertyId+" select").each(function(){var v=$(this).clone().attr("id",$(this).attr("name")+"input").css("position","absolute").css("display","none").css("z-index","1000");$("#"+t.ids.centerId).append(v);v.change(function(){$("#"+t.ids.fieldPropertyId+" [name="+$(this).attr("name")+"]").val($(this).val()).change();$(this).css("display","none");});v.blur(function(){$(this).css("display","none");});});jQuery.validator.addMethod("uniqueName",function(x,w){for(var v=0;v<q.fields.length;v++){if(v!=q.index&&q.fields[v].fieldName.toUpperCase()==x.toUpperCase()){return false;}}return true;},"字段名已经存在");jQuery.validator.addMethod("historyUniqueName",function(x,w){for(var v=0;v<q.deletedFields.length;v++){if(q.deletedFields[v].fieldName.toUpperCase()==x.toUpperCase()&&q.deletedFields[v].fieldId!=$("#fieldId").val()){return false;}}return true;},"字段名在历史版本中已经存在");jQuery.validator.addMethod("uniqueTableName",function(y,x){for(var w=0;w<t.allUnpublishedVersionTable.length;w++){var v=t.allUnpublishedVersionTable[w].tableName;if(v.toUpperCase()==y.toUpperCase()&&(!t.table||t.table.tableName.toUpperCase()!=v.toUpperCase())){return false;}}return true;},"表名已经存在");jQuery.validator.addMethod("word",function(w,v){return/^\w*$/gi.test(w);},"只能输入字母数字和下划线");this.valid=$("#"+this.ids.fieldPropertyId).validate({rules:{fieldName:{required:true,uniqueName:true,word:true,historyUniqueName:function(){if(!q.fields[q.index].isnew){return true;}}},charLen:{required:true,digits:true,min:function(){if(!q.fields[q.index].isnew){return q.fields[q.index].charLen;}else{return 0;}}},intLen:{required:true,digits:true,min:function(){if(!q.fields[q.index].isnew){return q.fields[q.index].intLen;}else{return 0;}}},decimalLen:{required:true,digits:true,min:function(){if(!q.fields[q.index].isnew){return q.fields[q.index].decimalLen;}else{return 0;}}}},messages:{fieldName:{required:"字段名称必填"},charLen:{required:"文字长度必填",min:"文字长度不能小于{0}"},intLen:{required:"整数长度必填",min:"整数长度不能小于{0}"},decimalLen:{required:"小数长度必填",min:"小数长度不能小于{0}"}}});var s=$("#"+this.ids.tablePropertyId);this.tablevalid=s.validate({rules:{tableName:{required:true,uniqueTableName:true,word:true}},messages:{tableName:{required:"表名必填"}}});s.find(":radio[name=isMain]").click(function(){if($(this).val()=="1"){s.find("select[name=mainTableId]").closest("td").css("display","none");}else{s.find("select[name=mainTableId]").closest("td").css("display","");}});if(this.usableMainTables){for(var r=0;r<this.usableMainTables.length;r++){if(this.usableMainTables[r].isMain==1&&(!this.table||this.usableMainTables[r].tableName!=this.table.tableName)){s.find("select[name=mainTableId]").append(g.replace("#value",this.usableMainTables[r].tableId).replace("#text",this.usableMainTables[r].tableName));}}}if(this.table){var s=$("#"+this.ids.tablePropertyId);s.find(":hidden[name=tableId]").val(this.table.tableId);s.find(":hidden[name=versionNo]").val(this.table.versionNo);s.find(":hidden[name=isPublished]").val(this.table.isPublished);s.find(":text[name=tableName]").val(this.table.tableName);s.find(":text[name=tableDesc]").val(this.table.tableDesc);s.find("select[name=mainTableId]").val(this.table.mainTableId);s.find(":radio[name=isMain][value="+this.table.isMain+"]").click();if(this.table.versionNo>1){s.find(":text[name=tableName]").attr("disabled","disabled");s.find(":radio[name=isMain]").attr("disabled","disabled");}}};}function d(k,l){this.newField={fieldName:"",fieldDesc:"",fieldType:"varchar",isRequired:1,charLen:20,intLen:20,decimalLen:0,dictType:l.dictList[0].nodeKey,identity:l.identityList[0].alias,isList:1,isQuery:1,isDeleted:0,isHidden:0,isFlowVar:0,validRule:"",valueFrom:0,script:"",controlType:1,isnew:true},this.fieldList=k;this.historyManager=new f(k,l);k.fieldManager=this;this.addField=function(){this.fieldList.fields.push(jQuery.extend(true,{},this.newField));this.historyManager.addHistory();},this.delField=function(m){this.fieldList.fields.splice(m,1);this.historyManager.addHistory();},this.replaceField=function(m,n){this.fieldList.fields.splice(m,1,jQuery.extend(true,{},n));this.historyManager.addHistory();},this.moveField=function(o,m){var n=this.fieldList.fields[o];this.fieldList.fields[o]=this.fieldList.fields[m];this.fieldList.fields[m]=n;this.historyManager.addHistory();},this.updField=function(o,m,n){o[m]=n;this.historyManager.addHistory();};}function f(k,l){this.historys=[jQuery.extend(true,[],l.fieldList)];this.currHistory=0;this.historySize=100;this.fieldList=k;k.historyManager=this;this.addHistory=function(){var m=jQuery.extend(true,[],this.fieldList.fields);this.historys[this.currHistory].index=this.fieldList.index;if(this.currHistory==this.historySize-1){this.historys.shift();this.historys.push(m);}else{if(this.currHistory==this.historys.length-1){this.historys.push(m);this.currHistory++;}else{this.historys.splice(this.currHistory+1);this.historys.push(m);this.currHistory++;}}this.fieldList.updToolBar();},this.backHistory=function(){if(this.currHistory>0){this.currHistory--;var m=jQuery.extend(true,[],this.historys[this.currHistory]);this.fieldList.fields=m;this.fieldList.showFieldList();this.fieldList.selectField(m.index);}this.fieldList.updToolBar();},this.forwardHistory=function(){if(this.currHistory<this.historys.length-1){this.currHistory++;var m=jQuery.extend(true,[],this.historys[this.currHistory]);this.fieldList.fields=m;this.fieldList.showFieldList();this.fieldList.selectField(m.index);}this.fieldList.updToolBar();};}});