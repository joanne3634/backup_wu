var controlList=[{key:"1",value:$lang_form.editTable.control.text},{key:"15",value:$lang_form.editTable.control.datepicker},{key:"3",value:$lang_form.editTable.control.dictionary},{key:"11",value:$lang_form.editTable.control.select},{key:"4",value:$lang_form.editTable.control.userSingle},{key:"17",value:$lang_form.editTable.control.roleSingle},{key:"18",value:$lang_form.editTable.control.orgSingle},{key:"19",value:$lang_form.editTable.control.posSingle}];var DataTemplateEdit=function(){};DataTemplateEdit.prototype={init:function(){var a=this;this.initDisplaySetting();this.initConditionField();this.initSortField();this.initFilter();this.initExportField();this.initManageField();this.selectTr();$("#selectCondition").click(function(){a.selectCondition(a);});$("#selectSort").click(function(){a.selectSort(a);});},initDisplaySetting:function(){var e="#displayFieldTbl";this.handChange(e);this.handClick(e);var l=$($("#displayFieldTemplate .table-detail")[0]).clone(true,true);var m=$("#displayField").val();if($.isEmpty(m)){return;}var g=$.parseJSON(m);var n=new StringBuffer();for(var f=0,h;h=g[f++];){$("[var='index']",l).html(f);$("[var='name']",l).html(h.name);$("input[var='type']",l).attr("value",h.type);$("input[var='style']",l).attr("value",h.style);$("input[var='desc']",l).attr("value",h.desc);for(var d=0,b;b=h.right[d++];){var a=this.getHtmlTd(b.type,b.id,b.name,b.script);if(b.s==0){$("[var='fieldRight']",l).html(a);}else{if(b.s==1){$("[var='printRight']",l).html(a);}}}n.append(l.html());}$(e).append(n.toString());},getHtmlTd:function(b,c,d,a){var e=['<select name="displayFieldRight" class="change_right" var="right"  >','<option value="none" '+(b=="none"?'selected="selected"':"")+" >无</option>",'<option value="everyone"'+(b=="everyone"?'selected="selected"':"")+">所有人</option>",'<option value="user"'+(b=="user"?'selected="selected"':"")+">用户</option>",'<option value="role"'+(b=="role"?'selected="selected"':"")+">角色</option>",'<option value="org"'+(b=="org"?'selected="selected"':"")+">组织</option>",'<option value="orgMgr"'+(b=="orgMgr"?'selected="selected"':"")+">组织负责人</option>",'<option value="pos"'+(b=="pos"?'selected="selected"':"")+">岗位</option>",'<option value="script"'+(b=="script"?'selected="selected"':"")+">脚本</option>","</select>",'<span name="displayFieldRight_span"  '+(b=="script"||b=="none"||b=="everyone"?'style="display: none;" ':"")+">",'<input type="hidden"  var="rightId"  value="'+c+'">','<textarea  readonly="readonly" var="rightName"  cols="40" rows="3">'+d+"</textarea>",'<a class="link-get" href="#"><span class="link-btn">选择</span></a>',"</span>",'<span class="displayFieldRight_script_span" '+(b!="script"?'style="display: none;" ':"")+">",'<textarea  cols="40" rows="3"  var="rightScript" >'+a+"</textarea>",'<a  href="#" name="btnScript" class="link var" title="常用脚本" onclick="__DataTemplate__.selectScript(this,false)">常用脚本</a>',"</span>"];return e.join("");},selectTr:function(){$("tr.odd,tr.even").each(function(){$(this).bind("mousedown",function(b){if(b.target.tagName=="TD"){var a='input:checkbox[class="pk"],input:radio[class="pk"]';var d=$(this).find(a);if(d.length==1){var c=d.attr("checked");d.attr("checked",!c);}}});});},handChange:function(b){var a=this;$(b).delegate("select.change_right","change",function(){var e=$(this),h=e.next(),g=h.next();a.showSpan(e.val(),h);var f=$("textarea",h),d=$("input:hidden",h);f.val("");d.val("");var c=$("textarea",g);c.val("");});},showSpan:function(a,b){switch(a){case"user":case"role":case"org":case"orgMgr":case"pos":b.show();b.next().hide();break;case"script":b.hide();b.next().show();break;case"everyone":case"none":b.hide();b.next().hide();break;}},handClick:function(a){$(a).delegate("a.link-get","click",function(){var d=$(this),f=d.prev(),b=f.prev(),e=d.parent().prev(),c=e.val();var g=function(h,i){f.val(i);b.val(h);};switch(c){case"user":UserDialog({callback:g});break;case"role":RoleDialog({callback:g});break;case"org":case"orgMgr":OrgDialog({callback:g});break;case"pos":PosDialog({callback:g});break;}});},initExportField:function(){var h="#exportFieldTbl";this.handChange(h);this.handClick(h);var n=$($("#exportFieldTemplate .table-detail")[0]).clone(true,true);var o=$($("#exportFieldTemplate .table-list")[0]).clone(true,true);var e=$("#exportField").val();if($.isEmpty(e)){return;}var r=$.parseJSON(e);var q=new StringBuffer();for(var b=0,s;s=r[b++];){$("input[var='tablename']",o).val(s.tableName);$("input[var='tabledesc']",o).val(s.tableDesc);$("input[var='ismain']",o).val(s.isMain);$("[var='table']",o).html(s.tableDesc+"("+s.tableName+")");q.append(o.html());for(var g=0,m;m=s.fields[g++];){$("[var='index']",n).html(g);$("[var='name']",n).html(m.name);$("input[var='type']",n).attr("value",m.type);$("input[var='style']",n).attr("value",m.style);$("input[var='desc']",n).attr("value",m.desc);$("input[var='tablename']",n).attr("value",m.tableName);$("input[var='ismain']",n).attr("value",m.isMain);for(var f=0,d;d=m.right[f++];){var a=this.getHtmlTd(d.type,d.id,d.name,d.script);if(d.s==2){$("[var='exportRight']",n).html(a);}}q.append(n.html());}}$(h).append(q.toString());},initConditionField:function(){var e=$("#conditionField").val();if($.isEmpty(e)){return;}var a=$.parseJSON(e);for(var b=0,f;f=a[b++];){var d=this.constructConditionTr(f);$("#conditionTbl tbody").append(d);}},selectCondition:function(a){var b=$("input[name='conditionType']:checked").val();$("#condition-columnsTbl input:[name='select']:checked").each(function(){var g=$(this),e=g.attr("fieldname"),d=g.attr("fieldtype"),c=g.attr("fielddesc"),f=g.attr("controltype"),i=$("#conditionTbl");if(a.isExistName(i,"name",e)){var j={na:e,ty:d,op:1,cm:c,va:"",vf:1,ct:f,qt:a.getQueryType(d,1)};var h=a.constructConditionTr(j);$("#conditionTbl tbody").append(h);}});},constructConditionTr:function(y){var A=y.ty,n=y.na,l=y.cm,q=y.op,d=y.va,D=y.vf;ct=y.ct;qt=y.qt;var t=this.constructTag("td",{"var":"name"},n);var w=this.constructTag("input",{type:"hidden",value:JSON2.stringify(y)});t.append(w);var u=this.constructTag("td");var g=this.constructTag("input",{name:"cm",value:l,type:"text","class":"inputText"});u.append(g);var m=this.constructTag("td");var b=this.constructTag("select",{name:"ct",style:"width:70px;"});b=this.getCtSelect(b,ct,A);m.append(b);var C=this.constructTag("td");var j=this.constructTag("select",{name:"op",style:"width:70px;"});j=this.getOpSelect(j,q,A);C.append(j);var s=this.constructTag("td");var z=this.constructTag("select",{name:"vf",onchange:"__DataTemplate__.selectValueFrom(this)"});z.append(this.constructOption(D,1,"表单输入"));s.append(z);var v=this.constructTag("td");var B=this.constructTag("a",{href:"#",name:"btnScript","class":"hide link var",title:"常用脚本",onclick:"__DataTemplate__.selectScript(this,true)"},"常用脚本");var r={};if(D==1){r=this.constructTag("input",{name:"va",type:"text","class":"hide",readonly:"readonly"});}else{if(D==2){r=this.constructTag("input",{name:"va",type:"text"});}else{if(D==3){r=this.constructTag("textarea",{name:"va"});B.show();}else{r=this.constructTag("select",{name:"va"});var k=this.getParameters();for(var x=0;x<k.length;x++){p=k[x];r.append(this.constructTag("option",{value:p.na},p.cm+"("+p.na+")"));}}}}r.val(d);v.append(B);v.append(r);var e=this.constructTag("td");var o=this.constructTag("a",{href:"#","class":"link moveup",onclick:"__DataTemplate__.moveTr(this,true)"},"");var f=this.constructTag("a",{href:"#","class":"link movedown",onclick:"__DataTemplate__.moveTr(this,false)"},"");var h=this.constructTag("a",{href:"#","class":"link del",onclick:"__DataTemplate__.delTr(this)"},"");e.append(o).append(f).append(h);var c=this.constructTag("tr");c.append(t).append(u).append(m).append(C).append(s).append(v).append(e);return c;},getCtSelect:function(c,d,b){var a=this;if(b=="date"){c.append(a.constructOption(d,"15","日期控件"));}else{$(controlList).each(function(e,f){switch(f.key){case"1":case"2":case"9":case"10":case"16":case"21":c.append(a.constructOption(d,"1",f.value));break;default:c.append(a.constructOption(d,f.key,f.value));break;}});}return c;},getOpSelect:function(b,c,a){switch(a){case"varchar":b.append(this.constructOption(c,"1","="));b.append(this.constructOption(c,"2","!="));b.append(this.constructOption(c,"3","like"));break;case"number":case"int":b.append(this.constructOption(c,"1","="));b.append(this.constructOption(c,"2",">"));b.append(this.constructOption(c,"3","<"));b.append(this.constructOption(c,"4",">="));b.append(this.constructOption(c,"5","<="));break;case"date":b.append(this.constructOption(c,"6","日期范围"));b.append(this.constructOption(c,"1","="));b.append(this.constructOption(c,"2",">"));b.append(this.constructOption(c,"3","<"));b.append(this.constructOption(c,"4",">="));b.append(this.constructOption(c,"5","<="));break;default:b.append(this.constructOption(c,"1","="));b.append(this.constructOption(c,"2",">"));b.append(this.constructOption(c,"3","<"));b.append(this.constructOption(c,"4",">="));b.append(this.constructOption(c,"5","<="));}return b;},constructOption:function(b,a,d){if(!d){d=a;}var c=this.constructTag("option",{value:a},d);if(b==a){c.attr("selected","selected");}return c;},selectValueFrom:function(j){var f=$(j).closest("tr");var c=f.find("a:[name='btnScript']");c.hide();var b=$(j).val();var h;if(b==1){h=this.constructTag("input",{name:"va",type:"text","class":"hide",readonly:"readonly"});}else{if(b==2){h=this.constructTag("input",{name:"va",type:"text"});}else{if(b==3){c.show();h=this.constructTag("textarea",{name:"va"});}else{h=this.constructTag("select",{name:"va"});var e=this.getParameters();for(var d=0;d<e.length;d++){var g=e[d];h.append(this.constructTag("option",{value:g.na},g.cm+"("+g.na+")"));}}}}f.find("[name='va']").replaceWith(h);},getParameterSetting:function(){var a={fieldSetting:new Array(),conditionField:new Array(),parameters:new Array()};return a;},constructTag:function(b,d,e){var a=$("<"+b+"></"+b+">");if(d){for(var c in d){a.attr(c,d[c]);}}if(e){a.text(e);}return a;},getQueryType:function(a,c){var b="S";switch(a){case"varchar":if(c){switch(c){case 1:case 2:b="S";break;case 3:b="SL";break;case 4:b="SLL";break;case 5:b="SLR";break;default:b="S";break;}}break;case"number":b="L";break;case"int":b="N";break;case"date":if(c==6){b="DR";}else{b="DL";}break;default:b="S";break;}return b;},initSortField:function(){var g=$($("#sortTemplate .table-detail tr")[0]).clone(true,true);var f=$("#sortField").val();if($.isEmpty(f)){return;}var b=$.parseJSON(f);for(var d=0,j;j=b[d++];){try{$("[var='name']",g).html(j.name);$("[var='desc']",g).html(j.desc);$("[var='source']",g).html(j.source);$("[var='sort']",g).val(j.sort);}catch(h){}var a=g.clone(true,true);$("#sortTbl tbody").append(a);}},selectSort:function(a){var b=$($("#sortTemplate .table-detail tr")[0]).clone(true,true);$("#sort-columnsTbl input:[name='select']:checked").each(function(){var e=$(this),d=e.attr("fieldname"),g=e.attr("fielddesc");var f=$("#sortTbl");if(a.isExistName(f,"name",d)){$("[var='name']",b).html(d);$("[var='desc']",b).html(g);var c=b.clone(true,true);$("#sortTbl tbody").append(c);}});},isExistName:function(c,d,a){var b=true;c.find("[var='"+d+"']").each(function(){var e=$(this),f=e.html();if(f==a){b=false;return true;}});return b;},initManageField:function(){this.handChange("#manageTbl");this.handClick("#manageTbl");this.handSelect("#manageTbl");var l=$($("#manageTemplate .table-detail tr")[0]).clone(true,true);var g=$("#manageField").val();if($.isEmpty(g)){return;}var n=$.parseJSON(g);var m=new StringBuffer();for(var f=0,h;h=n[f++];){$("input[var='desc']",l).val(h.desc);$("select[var='name']",l).val(h.name);for(var d=0,b;b=h.right[d++];){var a=this.getHtmlTd(b.type,b.id,b.name,b.script);$("[var='manageRight']",l).html(a);}var e=l.clone(true,true);$("#manageTbl tbody").append(e);}},addManage:function(){var a=$($("#manageTemplate .table-detail tr")[0]).clone(true,true);var b=this.getHtmlTd("none","","","");$("[var='manageRight']",a).html(b);$("#manageTbl tbody").append(a);},delManage:function(){this.delSelectTr("manageTbl");},initFilter:function(){this.handChange("#filterTbl");this.handClick("#filterTbl");var f=$($("#filterTemplate .table-detail tr")[0]).clone(true,true);var e=$("#filterField").val();if($.isEmpty(e)){return;}var a=$.parseJSON(e);var h=new StringBuffer();for(var b=0,g;g=a[b++];){var d={};d.name=g.name;d.key=g.key;d.type=g.type;d.condition=g.condition;d.right=g.right[0];this.addFilterTr(f,d);}},addFilterTr:function(f,e){var b=e.name,h=e.key,g=e.type,c=e.condition,i=e.right;var a=this.getHtmlTd(i.type,i.id,i.name,i.script);$("[var='name']",f).html(b);$("[var='key']",f).html(h);$("[var='type']",f).val(g);$("[var='typeshow']",f).html(g==2?"SQL":"条件脚本");$("[var='condition']",f).val(c);$("[var='filterRight']",f).html(a);var d=f.clone(true,true);$("#filterTbl tbody").append(d);},addFilter:function(b){var a=this,d=$("#tableId").val(),f=$("#source").val(),e=$($("#filterTemplate .table-detail tr")[0]).clone(true,true);var c={};c.type="none";c.id="";c.name="";c.script="";this.filterDialog({tableId:d,source:f,callback:function(i){if(i){var h={},g=i.type,j=(g==2?i.condition:JSON2.stringify(i.condition));h.name=i.name;h.key=i.key;h.type=g;h.condition=j;h.right=c;a.addFilterTr(e,h);}}});},filterDialog:function(d){var f=750;var c=500;d=$.extend({},{dialogWidth:f,dialogHeight:c,help:0,status:0,scroll:0,center:1},d);var a="dialogWidth="+d.dialogWidth+"px;dialogHeight="+d.dialogHeight+"px;help="+d.help+";status="+d.status+";scroll="+d.scroll+";center="+d.center;var b=__ctx+"/platform/form/bpmDataTemplate/filterDialog.ht?tableId="+d.tableId;b=b.getNewUrl();var e=window.showModalDialog(b,d,a);if(e&&d.callback){d.callback.call(this,e);}},delFilter:function(){this.delSelectTr("filterTbl");},editFilter:function(c){var b=$(c).parents("tr"),a={};a.name=$("[var='name']",b).html();a.key=$("[var='key']",b).html();a.type=$("[var='type']",b).val();a.condition=$("[var='condition']",b).val();this.editFilterDialog(b,a);},editFilterDialog:function(e,b){var a=this,c=$("#tableId").val(),d=$("#source").val();this.filterDialog({tableId:c,source:d,filter:b,callback:function(g){if(g){var f=g.type;var h=(f==2?g.condition:JSON2.stringify(g.condition));$("[var='name']",e).html(g.name);$("[var='key']",e).html(g.key);$("[var='type']",e).val(f);$("[var='typeshow']",e).html(f==2?"SQL":"条件脚本");$("[var='condition']",e).val(h);}}});},switchNeedPage:function(c){var b=$(c),a=$("#spanPageSize");var d=b.val();if(d==1){a.show();}else{a.hide();}},delTr:function(a){$(a).closest("tr").remove();},delSelectTr:function(b){var a=this;$("#"+b+" input:[name='select']:checked").each(function(){a.delTr(this);});},moveTr:function(e,d){var c=$(e).parents("tr");if(d){var b=$(c).prev();if(b){c.insertBefore(b);}}else{var a=$(c).next();if(a){c.insertAfter(a);}}},selectScript:function(c,a){var b=$(c),d={};if(a){d=b.next()[0];}else{d=b.prev()[0];}if(d){ScriptDialog({callback:function(e){$.insertText(d,e);}});}},handSelect:function(a){$(a).delegate("select[var='name']","change",function(){var b=$(this),d=b.children("option:selected").text();tr=b.closest("tr");var c=$("[var='desc']",tr);c.val(d);});}};var __DataTemplate__=new DataTemplateEdit();