Namespace.register("com.deelon.platform.form");$(function(){var b=[{key:"varchar",value:"文字"},{key:"number",value:"数字"},{key:"date",value:"日期"}];var j={};$(b).each(function(l,m){j[m.key]=m.value;});var k=[{key:"1",value:"单行文本框"},{key:"2",value:"多行文本框"},{key:"3",value:"数据字典"},{key:"4",value:"人员选择器"},{key:"5",value:"角色选择器"},{key:"6",value:"组织选择器"}];var c=[{key:"0",value:"表单输入"},{key:"1",value:"脚本运算"}];var a=[{key:"0",value:"无"},{key:"1",value:"GUID"},{key:"2",value:"流水号"},{key:"3",value:"时间序列"}];var h='<option value="#value">#text</option>';var i='<input name="#name" type="checkbox" value="1" #checked/>';com.deelon.platform.form.TableManager=function(m,l){this.ids=m.id;this.fieldList=new d(m,l);this.fieldProperty=new f(m,this.fieldList);this.validate=function(){return this.fieldProperty.validateAll();},this.showAllError=function(){this.fieldProperty.showAllError();},this.getData=function(){var r=$("#"+this.ids.tablePropertyId);var u=r.find("[name=keyType]").val();var v="";if(u==2){v=r.find("[name=keyValue]").val();}var s=r.find("[name=pkField]").val();var o={tableId:r.find(":hidden[name=tableId]").val(),tableName:r.find(":text[name=tableName]").val(),tableDesc:r.find(":text[name=tableDesc]").val(),versionNo:1,isPublished:1,isExternal:1,isMain:r.find(":radio[name=isMain][checked]").val(),keyType:u,keyValue:v,pkField:s};var t=JSON2.stringify(o);var n="[";for(var q=0;q<this.fieldList.fields.length;q++){n+=JSON2.stringify(this.fieldList.fields[q])+",";}n+="]";return{table:t,fields:n};};};function d(o,q){var r=o.data;this.index=-1;this.fields=[];this.deletedFields=[];this.allFields=[];if(r&&r.fieldList){var l=r.fieldList;for(var n=0;n<l.length;n++){if(l[n].isDeleted=="0"){this.fields.push(l[n]);}else{this.deletedFields.push(l[n]);}this.allFields.push(jQuery.extend(true,[],l[n]));}}this.layout=q;this.ids=o.id;var m=this;setTimeout(function(){m.init();m.showFieldList();},1);this.setFieldProperty=function(s){this.fieldProperty=s;return this;},this.selectField=function(s){if(s==null){s=-1;}if(s>-1){if(this.layout.isBottomCollapse){this.layout.setBottomCollapse(false);}}else{this.layout.setBottomCollapse(true);this.fieldProperty.resetForm();}if(this.index!=s){if(this.index!=-1&&!this.fieldProperty.validate()){this.fieldProperty.showError();return false;}this.index=s;$("#"+this.ids.fieldListId+" tr").removeClass("even");if(s>-1){$("#r"+s).addClass("even");this.fieldProperty.showDetail();}}return true;},this.setEditorTo=function(y,w){if(!$(y).attr("name")||$(y).find(":checkbox").length>0||(!this.fields[w].isnew&&$(y).is("[name=fieldType]"))){return;}else{if($(y).is(":checkbox")){if($(y).attr("checked")){$("#"+this.ids.fieldPropertyId+" [name="+$(y).attr("name")+"]").attr("checked","checked").change();}else{$("#"+this.ids.fieldPropertyId+" [name="+$(y).attr("name")+"]").removeAttr("checked").change();}return;}}var v=$(y).attr("name");var u=$("#"+v+"input");var t=$(y).position();var x=this.fields[w][v];if(u.is(":text")){x=$(y).text();}var s=$("#"+this.ids.centerId);u.css("left",t.left+s.scrollLeft()+1).css("top",t.top+s.scrollTop()+1).css("width",$(y).width()-2).css("height",$(y).height()-2).css("display","").val(x);setTimeout(function(){u.focus();},1);},this.showFieldList=function(){$("#"+this.ids.fieldListId+" tr:gt(0)").remove();var t='<tr id="r#id">';$("#"+this.ids.fieldListId+" tr:eq(0) th").each(function(){t+='<td name="'+$(this).attr("name")+'">#'+$(this).attr("name")+"</td>";});t+="</tr>";var s=this;$(this.fields).each(function(u,w){var v=t.replace("#id",u).replace("#lineNO",u+1);$(v).find("[name]").each(function(){var x=$(this).attr("name");v=v.replace("#"+x,s.getHtml(x,w[x],w));});$("#"+s.ids.fieldListId).append(v);});this.index=-1;this.reset();},this.moveupField=function(){if(this.index>0){var s=this.index-1;this.fieldManager.moveField(this.index,s);this.showFieldList();$("#"+this.ids.fieldListId+" #r"+s+" td:last").click();}},this.movedownField=function(){if(this.index>-1&&this.index<this.fields.length-1){var s=this.index+1;this.fieldManager.moveField(this.index,s);this.showFieldList();$("#"+this.ids.fieldListId+" #r"+s+" td:last").click();}},this.addField=function(){if(this.index!=-1&&!this.fieldProperty.validate()){this.fieldProperty.showError();return;}this.fieldManager.addField();this.showFieldList();$("#"+this.ids.fieldListId+" tr:last td[name]:eq(1)").click();var s=$("#"+this.ids.centerId);s.scrollTop(s.height());},this.delField=function(){if(this.index>-1){var t=this.fields[this.index].isRequired;if(t==1){$.ligerMsg.info("该字段为必填字段，不能删除!");return;}this.fieldManager.delField(this.index);var s=this.index;if(!(s<this.fields.length)){s--;}this.showFieldList();this.selectField(s);}else{$.ligerMsg.info("请先选择字段");}},this.backHistory=function(){this.historyManager.backHistory();},this.forwardHistory=function(){this.historyManager.forwardHistory();},this.updToolBar=function(){if(this.ids.backHistoryId){$("#"+this.ids.backHistoryId).html($("#"+this.ids.backHistoryId).html().replace(/\(\d+\)/g,"("+this.historyManager.currHistory+")"));}if(this.ids.forwardHistoryId){$("#"+this.ids.forwardHistoryId).html($("#"+this.ids.forwardHistoryId).html().replace(/\(\d+\)/g,"("+(this.historyManager.historys.length-this.historyManager.currHistory-1)+")"));}},this.getHtml=function(t,v,w){var u="";if(t=="fieldType"){u=j[v];if(v=="varchar"){u+="("+w.charLen+")";if(w.valueFrom==0){if(w.controlType==1||w.controlType==2){u+=",验证:"+(w.validRule==""?"无":w.validRule);}else{if(w.controlType==3){u+=",数据字典:"+this.fieldProperty.dictMap[w.dictType];}}}else{if(w.valueFrom==1){u+=",脚本运算";}}}else{if(v=="number"){u+="("+w.intLen+","+w.decimalLen+")";}}}else{if(t=="isRequired"){u=(v=="1"?"√":"");}else{if(t=="isList"||t=="isQuery"||t=="isDeleted"){var s=(v=="1"?"checked":"");u=i.replace("#name",t).replace("#checked",s);}else{u=v;}}}return u;},this.reset=function(){var s=this;$("#"+this.ids.fieldListId+" td").unbind("click");$("#"+this.ids.fieldListId+" td, #"+this.ids.fieldListId+" :checkbox").click(function(){var u=parseInt($(this).parents("tr").attr("id").replace("r",""));var t=s.selectField(u);if(!t){return false;}s.setEditorTo(this,u);});},this.init=function(){var s=this;if(this.ids.addFieldId){$("#"+this.ids.addFieldId).click(function(){s.addField();});}if(this.ids.backHistoryId){$("#"+this.ids.backHistoryId).click(function(){s.backHistory();});}if(this.ids.forwardHistoryId){$("#"+this.ids.forwardHistoryId).click(function(){s.forwardHistory();});}if(this.ids.moveupFieldId){$("#"+this.ids.moveupFieldId).click(function(){s.moveupField();});}if(this.ids.movedownFieldId){$("#"+this.ids.movedownFieldId).click(function(){s.movedownField();});}if(this.ids.delFieldId){$("#"+this.ids.delFieldId).click(function(){s.delField();});}};}function f(n,l){var o=n.data;this.valid=null;this.tablevalid=null;this.table=o.table;this.identityList=o.identityList;this.dictList=o.dictList;this.dictMap={};for(var m=0;m<this.dictList.length;m++){this.dictMap[this.dictList[m].nodeKey]=this.dictList[m].typeName;}this.validRuleList=o.validRuleList;this.fieldList=l;this.ids=n.id;this.fieldManager=new e(l,o);l.setFieldProperty(this);var q=this;setTimeout(function(){q.init();},1);this.setFieldList=function(r){this.fieldList=r;return this;},this.validate=function(){return this.valid.checkForm();},this.validateAll=function(){var r=true;if(!this.valid.checkForm()){r=false;}if(!this.tablevalid.checkForm()){r=false;}return r;},this.showError=function(){this.valid.showErrors();var t=this.valid.errorList;var s="请先处理当前的错误：";for(var r=0;r<t.length;r++){s+='<font color="red"><p>'+t[r].message+"</p></font>";}$.ligerMsg.info(s);},this.showAllError=function(){this.valid.showErrors();this.tablevalid.showErrors();var t=this.tablevalid.errorList;t=t.concat(this.valid.errorList);var s="请先处理当前的错误：";for(var r=0;r<t.length;r++){s+='<font color="red"><p>'+t[r].message+"</p></font>";}$.ligerMsg.info(s);},this.resetForm=function(){this.valid.resetForm();},this.showDetail=function(){this.resetForm();var s=$("#"+this.ids.fieldPropertyId);var t=this.fieldList.fields[this.fieldList.index];for(p in t){var r=s.find("[name="+p+"]");if(r.is(":checkbox")){if(r.val()==t[p]){r.attr("checked","checked");}else{r.removeAttr("checked");}if(p=="isRequired"){r.attr("disabled","disabled");}}else{if(p=="fieldName"){r.text(t[p]);}else{r.val(t[p]);}}}this.changeDisplay();},this.changeDisplay=function(){var t=$("#"+this.ids.fieldPropertyId);var r=t.find("select[name=fieldType]").val();var s=t.find("select[name=valueFrom]").val();var u=t.find("select[name=controlType]").val();if(!this.fieldList.fields[this.fieldList.index].isnew){t.find("select[name=fieldType]").attr("disabled","disabled");}else{t.find("select[name=fieldType]").removeAttr("disabled");}if(r=="varchar"){t.find("input[name=charLen]").closest("tr").css("display","").attr("disabled","disabled");t.find("input[name=intLen]").closest("tr").css("display","none").attr("disabled","disabled");}else{if(r=="number"){t.find("input[name=charLen]").closest("tr").css("display","none").attr("disabled","disabled");t.find("input[name=intLen]").closest("tr").css("display","").attr("disabled","disabled");}else{if(r=="date"){t.find("input[name=charLen]").closest("tr").css("display","none").attr("disabled","disabled");t.find("input[name=intLen]").closest("tr").css("display","none").attr("disabled","disabled");}}}if(r=="varchar"&&s=="0"){t.find("select[name=controlType]").closest("tr").css("display","");}else{t.find("select[name=controlType]").closest("tr").css("display","none");}if(r=="varchar"&&s=="0"&&(u=="1"||u=="2")){t.find("select[name=validRule]").closest("tr").css("display","");}else{t.find("select[name=validRule]").closest("tr").css("display","none");}if(r=="varchar"&&s=="0"&&u=="3"){t.find("select[name=dictType]").closest("tr").css("display","");}else{t.find("select[name=dictType]").closest("tr").css("display","none");}if(s=="1"){t.find("textarea[name=script]").closest("tr").css("display","");}else{t.find("textarea[name=script]").closest("tr").css("display","none");}},this.init=function(){var C=this;var z=this.fieldList;$("#"+this.ids.fieldPropertyId+" input, #"+this.ids.fieldPropertyId+" select, #"+this.ids.fieldPropertyId+" textarea").change(function(){var I=$(this).attr("name");if(z.index>-1){var L=$("#r"+z.index).find("[name="+I+"]");if($(this).is(":checkbox")){if($(this).attr("checked")){L.children(":checkbox").attr("checked","checked");}else{L.children(":checkbox").removeAttr("checked");}}if(C.valid.element(this)){if($(this).is("[name=fieldName]")){$("#"+C.ids.fieldPropertyId+" select[name=fieldType]").removeAttr("disabled");for(var J=0;J<z.allFields.length;J++){if($(this).val()==z.allFields[J].fieldName){var H=this;$.ligerDialog.confirm($(H).val()+"在历史版本中已经存在,系统将会导入进来,并且数据类型不可更改,是否使用"+$(H).val()+"?","提示信息",function(M){if(M){L.html($(H).val());this.fieldManager.replaceField(z.index,z.allFields[J]);z.showFieldList();z.selectField(z.fields.length-1);}else{$(H).val(z.fields[z.index].fieldName);}});return;}}}var K=$(this).val();if($(this).is(":checkbox")&&!$(this).attr("checked")){K="0";}C.fieldManager.updField(z.fields[z.index],I,K);}if(!$(this).is(":checkbox")){L.html(z.getHtml(I,$(this).val(),z.fields[z.index]));$("#r"+z.index).find("[name=fieldType]").html(z.getHtml("fieldType",z.fields[z.index].fieldType,z.fields[z.index]));}}});$("#"+this.ids.fieldPropertyId+" select[name=fieldType], #"+this.ids.fieldPropertyId+" select[name=valueFrom], #"+this.ids.fieldPropertyId+" select[name=controlType]").change(function(){C.changeDisplay();});var F=$("#"+this.ids.fieldPropertyId);var G=F.find("select[name=dictType]");var u=F.find("select[name=fieldType]");var t=F.find("select[name=validRule]");var y=F.find("select[name=valueFrom]");var v=F.find("select[name=controlType]");$(this.dictList).each(function(H,J){var I=h.replace("#value",J.nodeKey).replace("#text",J.typeName);G.append(I);});$(b).each(function(H,J){var I=h.replaceAll("#value",J.key).replace("#text",J.value);u.append(I);});$(this.validRuleList).each(function(H,J){var I=h.replaceAll("#value",J.name).replace("#text",J.name);t.append(I);});$(c).each(function(H,J){var I=h.replaceAll("#value",J.key).replace("#text",J.value);y.append(I);});$(k).each(function(H,J){var I=h.replaceAll("#value",J.key).replace("#text",J.value);v.append(I);});$("#"+this.ids.fieldPropertyId+" :text, #"+this.ids.fieldPropertyId+" select").each(function(){var H=$(this).clone().attr("id",$(this).attr("name")+"input").css("position","absolute").css("display","none").css("z-index","1000");$("#"+C.ids.fieldListId).append(H);H.change(function(){$("#"+C.ids.fieldPropertyId+" [name="+$(this).attr("name")+"]").val($(this).val()).change();$(this).css("display","none");});H.blur(function(){$(this).css("display","none");});});jQuery.validator.addMethod("uniqueName",function(J,I){for(var H=0;H<z.fields.length;H++){if(H!=z.index&&z.fields[H].fieldName==J){return false;}}return true;},"字段名已经存在");jQuery.validator.addMethod("historyUniqueName",function(J,I){for(var H=0;H<z.deletedFields.length;H++){if(z.deletedFields[H].fieldName==J&&z.deletedFields[H].fieldId!=$("#fieldId").val()){return false;}}return true;},"字段名在历史版本中已经存在");this.valid=$("#"+this.ids.fieldPropertyId).validate({rules:{fieldName:{required:true,uniqueName:true,historyUniqueName:function(){if(!z.fields[z.index].isnew){return true;}}},charLen:{required:true,digits:true,min:function(){if(!z.fields[z.index].isnew){return z.fields[z.index].charLen;}else{return 0;}}},intLen:{required:true,digits:true,min:function(){if(!z.fields[z.index].isnew){return z.fields[z.index].intLen;}else{return 0;}}},decimalLen:{required:true,digits:true,min:function(){if(!z.fields[z.index].isnew){return z.fields[z.index].decimalLen;}else{return 0;}}}},messages:{fieldName:{required:"字段名称必填"},charLen:{required:"文字长度必填",min:"文字长度不能小于{0}"},intLen:{required:"整数长度必填",min:"整数长度不能小于{0}"},decimalLen:{required:"小数长度必填",min:"小数长度不能小于{0}"}}});var E=$("#"+this.ids.tablePropertyId);this.tablevalid=E.validate({rules:{tableName:{required:true,uniqueTableName:true}},messages:{tableName:{required:"表名必填"}}});var D=E.find("select[name=keyType]");var r=E.find("select[name=keyValue]");var B=E.find("select[name=pkField]");$(a).each(function(H,J){var I=h.replaceAll("#value",J.key).replace("#text",J.value);D.append(I);});$(this.identityList).each(function(H,J){var I=h.replaceAll("#value",J.alias).replace("#text",J.name);r.append(I);});$(z.fields).each(function(H,J){var I=h.replaceAll("#value",J.fieldName).replace("#text",J.fieldDesc);B.append(I);});if(this.table){var E=$("#"+this.ids.tablePropertyId);E.find(":hidden[name=tableId]").val(this.table.tableId);E.find(":text[name=tableName]").val(this.table.tableName);E.find(":text[name=tableDesc]").val(this.table.tableDesc);E.find(":radio[name=isMain][value="+this.table.isMain+"]").click();E.find(":text[name=tableName]").attr("disabled","disabled");var s=this.table.pkField;var A=this.table.keyType;if(s!=undefined&&s!=""){E.find("select[name=pkField]").val(s);}if(A!=undefined&&A!=""){var x=this.table.keyValue;E.find("select[name=keyType]").val(A);var w=$("#tdKeyValue");if(A==2){E.find("select[name=keyValue]").val(x);w.css("display","");}else{w.css("display","none");}}}};}function e(l,m){this.newField={fieldName:"",fieldDesc:"",fieldType:"varchar",isRequired:1,charLen:20,intLen:20,decimalLen:0,dictType:m.dictList[0].nodeKey,isList:1,isQuery:1,isDeleted:0,validRule:"",valueFrom:0,script:"",controlType:1,isnew:true},this.fieldList=l;this.historyManager=new g(l,m);l.fieldManager=this;this.addField=function(){this.fieldList.fields.push(jQuery.extend(true,{},this.newField));this.historyManager.addHistory();},this.delField=function(n){this.fieldList.fields.splice(n,1);this.historyManager.addHistory();},this.replaceField=function(n,o){this.fieldList.fields.splice(n,1,jQuery.extend(true,{},o));this.historyManager.addHistory();},this.moveField=function(q,n){var o=this.fieldList.fields[q];this.fieldList.fields[q]=this.fieldList.fields[n];this.fieldList.fields[n]=o;this.historyManager.addHistory();},this.updField=function(q,n,o){q[n]=o;this.historyManager.addHistory();};}function g(l,m){this.historys=[jQuery.extend(true,[],m.fieldList)];this.currHistory=0;this.historySize=100;this.fieldList=l;l.historyManager=this;this.addHistory=function(){var n=jQuery.extend(true,[],this.fieldList.fields);this.historys[this.currHistory].index=this.fieldList.index;if(this.currHistory==this.historySize-1){this.historys.shift();this.historys.push(n);}else{if(this.currHistory==this.historys.length-1){this.historys.push(n);this.currHistory++;}else{this.historys.splice(this.currHistory+1);this.historys.push(n);this.currHistory++;}}this.fieldList.updToolBar();},this.backHistory=function(){if(this.currHistory>0){this.currHistory--;var n=jQuery.extend(true,[],this.historys[this.currHistory]);this.fieldList.fields=n;this.fieldList.showFieldList();this.fieldList.selectField(n.index);}this.fieldList.updToolBar();},this.forwardHistory=function(){if(this.currHistory<this.historys.length-1){this.currHistory++;var n=jQuery.extend(true,[],this.historys[this.currHistory]);this.fieldList.fields=n;this.fieldList.showFieldList();this.fieldList.selectField(n.index);}this.fieldList.updToolBar();};}});