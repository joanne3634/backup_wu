var wsTree,menu,menu_root,wsHeight,varHeight,varTree,dialog,varStruTree,_seq=1;$(function(){$("#webLayout").ligerLayout({leftWidth:350,height:"100%",allowLeftResize:false});varHeight=$("#varLayout").height();loadVarTree();$(".table-detail").delegate("select[name=bindingType]","change",function(){var a=$(this).closest("table");$("tr[bingdingType]",a).hide();$("tr[bingdingType="+$(this).val()+"]",a).show("fast");});$("#varTree").height(varHeight-20);$("#dataFormSave").click(function(){saveWebserviceSet();});if(bpmNodeWebServiceDocument){parseNodeWebservice(bpmNodeWebServiceDocument);}$("#add_custom").click(function(){if(dialog==null){dialog=$.ligerDialog.open({title:"添加自定义参数",target:$("#custom_param_div"),width:400,height:250,buttons:[{text:$lang.button.ok,onclick:updateCustomParam},{text:$lang.button.cancel,onclick:function(b,a){a.hide();}}]});}dialog.show();});});function updateCustomParam(f,c){var d=$("#custom_param_div"),h=$("input[name='id']",d).val(),a=$("input[name='name']",d).val(),g=$("select[name='paramType']",d).val(),e=$("input[name='description']",d).val();if(!a){$.ligerDialog.warn("提示信息","参数名称不能为空");}var b={id:h,name:a,paramType:g,description:e};b=varStruTree.addNodes(null,b);c.hide();}function getCustomParam(){var d=varStruTree.getNodes(),b=[];for(var a=0,e;e=d[a++];){b.push({id:e.id,name:e.name,setid:e.setid,paramType:e.paramType,description:e.description});}if(b&&b.length>0){return JSON2.stringify(b);}else{return"";}}function loadVarTree(){var setting={async:{enable:false},data:{key:{name:"name"}},view:{selectedMulti:false},edit:{drag:{prev:true,inner:true,next:true,isMove:true},enable:true,showRemoveBtn:false,showRenameBtn:false}};var url=__ctx+"/platform/bpmCommonWsSet/bpmCommonWsSet/getWsParams.ht";var params={setId:bpmNodeWebServiceSetId};$.post(url,params,function(result){var json=eval("("+result+")");varStruTree=$.fn.zTree.init($("#varTree"),setting,json);varStruTree.expandAll(true);$(".drag-span").dragspan({buddy:"varTree",treeDropHandler:function(t,n){t=$(t);t.text(n.name);t.attr("varId",n.id);t.closest("tr").next().find("td").html(n.paramType);}});});}function parseNodeWebservice(v){var v=eval("("+v+")");addMethodNode(v,true);}function saveWebserviceSet(){var obj={},me=$("table[zone=method]");if(!me){return;}var methodInfo=me.data("methodInfo"),inputTable=$(".table-detail[zone=binding]"),alias=$("input[name='alias']",me).val();if(!alias){$.ligerDialog.warn("WS调用别名不能为空");return;}if(methodInfo){obj.inputParams=methodInfo.inputParams.children;}obj.url=$("input[var=invokeUrl]",me).val();obj.serviceName=$("input[var=serviceName]",me).val();obj.soapaction=$("input[var=soapaction]",me).val();obj.method=$("td[var=method]",me).text();obj.namespace=$("td[var=namespace]",me).text();obj.inputs=[];for(var i=0,c;c=inputTable[i++];){var param={};param.name=$("span[var=name]",c).text();if(!param.name){continue;}param.fullpath=$("input[var=fullpath]",c).val();param.soapType=$("td[var=type]",c).text();param.bindingType=$("select[name=bindingType]",c).val();var binding=$("[name='defValue"+param.bindingType+"']",c);param.bindingVal=binding.val()?binding.val():binding.text();param.bindingVal=param.bindingVal.jsonEscape();param.javaType=javaType=$("[name=javaType]",c).text();obj.inputs.push(param);}var customParams=getCustomParam(),wsdlUrl=$("#wsdlTxt").val();obj=JSON2.stringify(obj);var url=__ctx+"/platform/bpmCommonWsSet/bpmCommonWsSet/save.ht";var setObj={};setObj.id=bpmNodeWebServiceSetId;setObj.alias=alias;setObj.wsdlUrl=wsdlUrl;setObj.document=obj;setObj=JSON2.stringify(setObj);$.post(url,{setObj:setObj,customParams:customParams},function(d){var result=eval("("+d+")");if(result.result){$.ligerDialog.success(result.message,"提示信息",function(){this.location.href="list.ht";});}else{$.ligerDialog.error(result.message,"出错了");}});}var addMethodNode=function(t,depParse){var params={wsdlUrl:t.url,nodeName:t.method,serviceName:t.serviceName};var setting={view:{addDiyDom:function(treeId,treeNode){var type=treeNode.type;var aObj=$("#"+treeNode.tId+"_a");aObj.append('<span style="margin-left:5px;">('+type+")</span>");},selectedMulti:false},check:{enable:true,chkboxType:{"Y":"","N":""}},callback:{beforeCheck:function(treeId,treeNode){if(!treeNode.type){return true;}if(treeNode.checked){if(confirm("是否取消当前参数["+treeNode.name+"]的绑定配置?")){var $div=$("#"+treeId+"-edit");if($div.length<1){return;}$("#"+treeNode.name+"_"+rep_list(treeNode.type)+"-edit",$div).remove();return true;}else{return false;}}return true;},onCheck:function(event,treeId,treeNode){var $div=$("#"+treeId+"-edit");if($div.length<1){return;}if(!treeNode.type){return;}if(treeNode.checked){$("#"+treeNode.tId+"_a").click();}else{var $editTable=$("#"+treeNode.tId+"-edit",$div);$editTable.remove();}},onClick:function(event,treeId,treeNode){if(!treeNode.checked){return;}var $div=$("#"+treeId+"-edit");cloneBindingTable(treeNode,$div);}}};$.ligerDialog.waitting("正在加载中,请稍候...");$.ajax({type:"POST",url:__ctx+"/platform/bpm/bpmNodeWebService/get.ht",data:params,dataType:"json",success:function(result){$.ligerDialog.closeWaitting();var json=eval("("+result+")");if(!json.success){$.ligerDialog.warn(json.msg,"提示信息");return false;}var operatorField=$("table[zone='method']");$(operatorField).data("methodInfo",json);$("[var=wsdl]",operatorField).html(json.wsdl);$("[var=method]",operatorField).html(json.method);$("[var=namespace]",operatorField).html(json.namespace);$("[var=soapaction]",operatorField).val(json.soapaction);$("[var=invokeUrl]",operatorField).val(json.invokeUrl);$("[var=serviceName]",operatorField).val(params.serviceName);$("[var=del]",operatorField).unbind();$("[var=del]",operatorField).click(function(e){$.ligerDialog.confirm("删除当前方法["+json.method+"]?","提示信息",function(rtn){if(rtn){operatorField.fadeOut(500,function(){$(this).remove();});}});});var $inputTreeUl=$("[var=inputTree]",operatorField);$inputTreeUl.attr("id","inputtree"+(_seq++));var inputTreeEdit=$("[var=inputTreeEdit]",operatorField);inputTreeEdit.attr("id",$inputTreeUl.attr("id")+"-edit");var inputParamsTree=$.fn.zTree.init($inputTreeUl,setting,json.inputParams);inputParamsTree.expandAll(true);setTimeout(function(){if(depParse){var inputs=t.inputs;for(var i=0,c;c=inputs[i++];){cloneBindingTable(c,inputTreeEdit,1);}}},200);},error:function(msg){$.ligerDialog.closeWaitting();$.ligerDialog.error("出错了！","提示信息");return;}});};function rep_list(a){if(!a){return a;}return a.replace(/[\{|\}]/g,"_");}function getFullPath(c){if(c.fullpath){return c.fullpath;}var e=c.level,a=[c.name];while(e>1){c=c.getParentNode();e=c.level;a.push(c.name);}var d,b=[];while(d=a.pop()){b.push(d);}return b.join(".");}function cloneBindingTable(a,e,f){if(e.length<1){return;}$("table",e).hide();if(!a.type&&!a.soapType){return;}var b=$("#"+a.name+"_"+rep_list(a.type)+"-edit",e),c=e.attr("var");if(b.length<1){b=$("#editField [zone=binding]").clone(true,true);$("input[var=fullpath]",b).val(getFullPath(a));$("span[var=name]",b).text(a.name);if(f){$("[var=type]",b).html(a.soapType);$("select[name=bindingType]",b).val(a.bindingType);b.attr("id",a.name+"_"+rep_list(a.soapType)+"-edit");}else{$("[var=type]",b).html(a.type);b.attr("id",a.name+"_"+rep_list(a.type)+"-edit");}if("outputTreeEdit"==c){$("a.tipinfo",b).removeClass("hidden");$("select[name=bindingType]",b).find("option").each(function(){if($(this).val()=="1"){$(this).remove();}});}e.append(b);b.hide();}b.fadeIn(function(){if(f){$("select[name=bindingType]",b).trigger("change");setTimeout(function(){var j=$("[name='defValue"+a.bindingType+"']",b);if(a.bindingType==1){j.val(a.bindingVal);}else{j.text(a.bindingVal.jsonUnescape());}$("[name=javaType]",b).text(a.javaType);var i=$("ul",e.siblings()).attr("id"),h=$.fn.zTree.getZTreeObj(i);if(h){var g=function(l){var k=getFullPath(l);return(k&&k==a.fullpath);};var d=h.getNodesByFilter(g,true);if(d){h.checkNode(d,true,true);}}},200);}});}function getByWsdlUrl(){var a=$("#wsdlTxt").val();if($.trim(a).length<1){$.ligerDialog.warn("还没有填写webService地址!","提示信息");return;}wsHeight=$("#wsLayout").height();$("#treeReFresh").click(function(){loadWsTree();});$("#treeExpand").click(function(){wsTree.expandAll(true);});$("#treeCollapse").click(function(){wsTree.expandAll(false);});loadWsTree();$("#wsTree").height(wsHeight-65);}function loadWsTree(){var setting={data:{key:{name:"name",wsdlUrl:"wsdlUrl"}},view:{selectedMulti:false},callback:{onDblClick:zTreeOnDblClick}};$.ligerDialog.waitting("正在查询中,请稍候...");$.ajax({type:"POST",url:__ctx+"/platform/bpm/bpmNodeWebService/getTreeData.ht",data:{"wsdlUrl":$("#wsdlTxt").val()},dataType:"json",success:function(result){$.ligerDialog.closeWaitting();var json=eval("("+result+")");wsTree=$.fn.zTree.init($("#wsTree"),setting,json);wsTree.expandAll(true);},error:function(msg){$.ligerDialog.closeWaitting();$.ligerDialog.error("输入WebService地址是否错误或者链接异常，请检查！","提示信息");return;}});}function zTreeOnDblClick(c,b,a){wsTree.selectNode(a);if(a.level==0){return;}else{if(wsTree==null){$.ligerDialog.warn("请先查询出webservice的方法","提示信息");return;}var a=getSelectNode();if(a&&a.level==0){$.ligerDialog.warn("请选择webservice的方法","提示信息");return;}a.serviceName=a.getParentNode().name;a.url=a.getParentNode().wsdlUrl;a.method=a.name;addMethodNode(a);}}function getSelectNode(){wsTree=$.fn.zTree.getZTreeObj("wsTree");var a=wsTree.getSelectedNodes();return a[0];}function closeWin(){$.ligerDialog.confirm("是否关闭当前窗口?","提示信息",function(a){if(a){window.close();}});}