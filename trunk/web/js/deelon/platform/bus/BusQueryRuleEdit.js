var BusQueryRuleEdit=function(){};BusQueryRuleEdit.prototype={init:function(){var a=this;this.initDisplaySetting();this.initSortField();this.initFilter();this.initExportField();this.selectTr();$("#selectSort").click(function(){a.selectSort(a);});},initDisplaySetting:function(){var e="#displayFieldTbl";this.handChange(e);this.handClick(e);var l=$($("#displayFieldTemplate .table-detail")[0]).clone(true,true);var m=$("#displayField").val();if($.isEmpty(m)){return;}var g=$.parseJSON(m);var n=new StringBuffer();for(var f=0,h;h=g[f++];){$("[var='index']",l).html(f);$("[var='name']",l).html(h.name);$("input[var='variable']",l).attr("value",h.variable);$("input[var='type']",l).attr("value",h.type);$("input[var='style']",l).attr("value",h.style);$("input[var='desc']",l).attr("value",h.desc);for(var d=0,b;b=h.right[d++];){var a=this.getHtmlTd(b.type,b.id,b.name,b.script);if(b.s==0){$("[var='fieldRight']",l).html(a);}else{if(b.s==1){$("[var='printRight']",l).html(a);}}}n.append(l.html());}$(e).append(n.toString());},getHtmlTd:function(b,c,d,a){var e=['<select name="displayFieldRight" class="change_right" var="right"  >','<option value="none" '+(b=="none"?'selected="selected"':"")+" >无</option>",'<option value="everyone"'+(b=="everyone"?'selected="selected"':"")+">所有人</option>",'<option value="user"'+(b=="user"?'selected="selected"':"")+">用户</option>",'<option value="role"'+(b=="role"?'selected="selected"':"")+">角色</option>",'<option value="org"'+(b=="org"?'selected="selected"':"")+">组织</option>",'<option value="orgMgr"'+(b=="orgMgr"?'selected="selected"':"")+">组织负责人</option>",'<option value="pos"'+(b=="pos"?'selected="selected"':"")+">岗位</option>",'<option value="script"'+(b=="script"?'selected="selected"':"")+">脚本</option>","</select>",'<span name="displayFieldRight_span"  '+(b=="script"||b=="none"||b=="everyone"?'style="display: none;" ':"")+">",'<input type="hidden"  var="rightId"  value="'+c+'">','<textarea  readonly="readonly" var="rightName"  cols="40" rows="3">'+d+"</textarea>",'<a class="link-get" href="#"><span class="link-btn">选择</span></a>',"</span>",'<span class="displayFieldRight_script_span" '+(b!="script"?'style="display: none;" ':"")+">",'<textarea  cols="40" rows="3"  var="rightScript" >'+a+"</textarea>",'<a  href="#" name="btnScript" class="link var" title="常用脚本" onclick="__BusQueryRule__.selectScript(this,false)">常用脚本</a>',"</span>"];return e.join("");},selectTr:function(){$("tr.odd,tr.even").each(function(){$(this).bind("mousedown",function(b){if(b.target.tagName=="TD"){var a='input:checkbox[class="pk"],input:radio[class="pk"]';var d=$(this).find(a);if(d.length==1){var c=d.attr("checked");d.attr("checked",!c);}}});});},handChange:function(b){var a=this;$(b).delegate("select.change_right","change",function(){var e=$(this),h=e.next(),g=h.next();a.showSpan(e.val(),h);var f=$("textarea",h),d=$("input:hidden",h);f.val("");d.val("");var c=$("textarea",g);c.val("");});},showSpan:function(a,b){switch(a){case"user":case"role":case"org":case"orgMgr":case"pos":b.show();b.next().hide();break;case"script":b.hide();b.next().show();break;case"everyone":case"none":b.hide();b.next().hide();break;}},handClick:function(a){$(a).delegate("a.link-get","click",function(){var d=$(this),f=d.prev(),b=f.prev(),e=d.parent().prev(),c=e.val();var g=function(h,i){f.val(i);b.val(h);};switch(c){case"user":UserDialog({callback:g});break;case"role":RoleDialog({callback:g});break;case"org":case"orgMgr":OrgDialog({callback:g});break;case"pos":PosDialog({callback:g});break;}});},initExportField:function(){var h="#exportFieldTbl";this.handChange(h);this.handClick(h);var n=$($("#exportFieldTemplate .table-detail")[0]).clone(true,true);var o=$($("#exportFieldTemplate .table-list")[0]).clone(true,true);var e=$("#exportField").val();if($.isEmpty(e)){return;}var q=$.parseJSON(e);var p=new StringBuffer();for(var b=0,r;r=q[b++];){$("input[var='tablename']",o).val(r.tableName);$("input[var='tabledesc']",o).val(r.tableDesc);$("input[var='ismain']",o).val(r.isMain);$("[var='table']",o).html(r.tableDesc+"("+r.tableName+")");p.append(o.html());for(var g=0,m;m=r.fields[g++];){$("[var='index']",n).html(g);$("[var='name']",n).html(m.name);$("input[var='type']",n).attr("value",m.type);$("input[var='style']",n).attr("value",m.style);$("input[var='desc']",n).attr("value",m.desc);$("input[var='tablename']",n).attr("value",m.tableName);$("input[var='ismain']",n).attr("value",m.isMain);for(var f=0,d;d=m.right[f++];){var a=this.getHtmlTd(d.type,d.id,d.name,d.script);if(d.s==2){$("[var='exportRight']",n).html(a);}}p.append(n.html());}}$(h).append(p.toString());},initSortField:function(){var g=$($("#sortTemplate .table-detail tr")[0]).clone(true,true);var f=$("#sortField").val();if($.isEmpty(f)){return;}var b=$.parseJSON(f);for(var d=0,j;j=b[d++];){try{$("[var='name']",g).html(j.name);$("[var='desc']",g).html(j.desc);$("[var='source']",g).html(j.source);$("[var='sort']",g).val(j.sort);}catch(h){}var a=g.clone(true,true);$("#sortTbl tbody").append(a);}},selectSort:function(a){var b=$($("#sortTemplate .table-detail tr")[0]).clone(true,true);$("#sort-columnsTbl input:[name='select']:checked").each(function(){var e=$(this),d=e.attr("fieldname"),g=e.attr("fielddesc");var f=$("#sortTbl");if(a.isExistName(f,"name",d)){$("[var='name']",b).html(d);$("[var='desc']",b).html(g);var c=b.clone(true,true);$("#sortTbl tbody").append(c);}});},isExistName:function(c,d,a){var b=true;c.find("[var='"+d+"']").each(function(){var e=$(this),f=e.html();if(f==a){b=false;return true;}});return b;},initFilter:function(){this.handChange("#filterTbl");this.handClick("#filterTbl");var f=$($("#filterTemplate .table-detail tr")[0]).clone(true,true);var e=$("#filterField").val();if($.isEmpty(e)){return;}var a=$.parseJSON(e);var h=new StringBuffer();for(var b=0,g;g=a[b++];){var d={};d.name=g.name;d.key=g.key;d.type=g.type;d.condition=g.condition;d.right=g.right[0];this.addFilterTr(f,d);}},addFilterTr:function(f,e){var b=e.name,h=e.key,g=e.type,c=e.condition,i=e.right;var a=this.getHtmlTd(i.type,i.id,i.name,i.script);$("[var='name']",f).html(b);$("[var='key']",f).html(h);$("[var='type']",f).val(g);$("[var='typeshow']",f).html(g==2?"SQL":"条件脚本");$("[var='condition']",f).val(c);$("[var='filterRight']",f).html(a);var d=f.clone(true,true);$("#filterTbl tbody").append(d);},addFilter:function(c){var a=this,b=$("#tableName").val(),e=$($("#filterTemplate .table-detail tr")[0]).clone(true,true);var d={};d.type="none";d.id="";d.name="";d.script="";this.filterDialog({tableName:b,callback:function(h){if(h){var g={},f=h.type,i=(f==2?h.condition:JSON2.stringify(h.condition));g.name=h.name;g.key=h.key;g.type=f;g.condition=i;g.right=d;a.addFilterTr(e,g);}}});},filterDialog:function(d){var f=750;var c=500;d=$.extend({},{dialogWidth:f,dialogHeight:c,help:0,status:0,scroll:0,center:1},d);var a="dialogWidth="+d.dialogWidth+"px;dialogHeight="+d.dialogHeight+"px;help="+d.help+";status="+d.status+";scroll="+d.scroll+";center="+d.center;var b=__ctx+"/platform/bus/busQueryRule/filterDialog.ht?tableName="+d.tableName;b=b.getNewUrl();var e=window.showModalDialog(b,d,a);if(e&&d.callback){d.callback.call(this,e);}},delFilter:function(){this.delSelectTr("filterTbl");},editFilter:function(c){var b=$(c).parents("tr"),a={};a.name=$("[var='name']",b).html();a.key=$("[var='key']",b).html();a.type=$("[var='type']",b).val();a.condition=$("[var='condition']",b).val();this.editFilterDialog(b,a);},editFilterDialog:function(d,c){var a=this,b=$("#tableName").val();this.filterDialog({tableName:b,filter:c,callback:function(f){if(f){var e=f.type;var g=(e==2?f.condition:JSON2.stringify(f.condition));$("[var='name']",d).html(f.name);$("[var='key']",d).html(f.key);$("[var='type']",d).val(e);$("[var='typeshow']",d).html(e==2?"SQL":"条件脚本");$("[var='condition']",d).val(g);}}});},switchNeedPage:function(c){var b=$(c),a=$("#spanPageSize");var d=b.val();if(d==1){a.show();}else{a.hide();}},delTr:function(a){$(a).closest("tr").remove();},delSelectTr:function(b){var a=this;$("#"+b+" input:[name='select']:checked").each(function(){a.delTr(this);});},moveTr:function(e,d){var c=$(e).parents("tr");if(d){var b=$(c).prev();if(b){c.insertBefore(b);}}else{var a=$(c).next();if(a){c.insertAfter(a);}}},selectScript:function(c,a){var b=$(c),d={};if(a){d=b.next()[0];}else{d=b.prev()[0];}if(d){ScriptDialog({callback:function(e){$.insertText(d,e);}});}},handSelect:function(a){$(a).delegate("select[var='name']","change",function(){var b=$(this),d=b.children("option:selected").text();tr=b.closest("tr");var c=$("[var='desc']",tr);c.val(d);});}};var __BusQueryRule__=new BusQueryRuleEdit();