var optiontemplate='<option value="#value">#text</option>';$(function(){getDialogs();$("select[name='methodName']").change(methodChange);$('select[name="paraCt"]').live("change",function(){var a=$(this).closest("div");if($(this).val()==0){$("#settingSpan",a).show();}else{$("#settingSpan",a).hide();}});});function getDialogs(){var a=__ctx+"/platform/form/bpmFormDialog/getAllDialogs.ht";$.ajax({type:"get",async:false,url:a,success:function(e){if(e){for(var d=0,f;f=e[d++];){var b=$('<option value="'+f.alias+'">'+f.name+"</option>");b.attr("fields",f.resultfield);$("select[name='dialog-type']",$("#settingSpan")).append(b);}}}});}function dialogChange(g){var h=$(g).find("option:selected");var b=h.attr("fields");if(b){var j=$(g).siblings("#dialog-param");var d=j.find("option:first-child");j.text("");j.append(d);var a=$.parseJSON(b);for(var c=0,e;e=a[c++];){d=$('<option value="'+e.field+'">'+e.comment+"</option>");j.append(d);}}}function methodChange(){var a=$(this).find("option:selected");if(!a){return;}var b=a.data("methodInfo");if(!b){return;}$("input[name='returnType']").val(b.returnType);var c=constructParamTable(b);$("#paraInfo").empty().append(c);}function getMethods(url){$.post(url,"",function(r){var data=eval("("+r+")");if(data.result){var methods=data.methods,methodSelect=$("select[name='methodName']").empty(),methodName=$("#methodName").val();for(var i=0,c;c=methods[i++];){var newOpt=$("<option></option>").val(c.methodName).text(c.methodName);if(c.methodName==methodName){var paraData=$("textarea[name='argument']").val();if(!paraData){continue;}paraData=eval("("+paraData+")");c.para=paraData;$(newOpt).attr("selected",true);}$(newOpt).data("methodInfo",c);methodSelect.append(newOpt);}methodSelect.trigger("change");}else{$.ligerDialog.error(data.message,$lang.tip.errorMsg);}});}function save(g){var f=false;var d=$("[id='settingSpan']");var j;for(var b=0;b<d.length;b++){j=d[b];if($(j).css("display")=="none"){continue;}var e=$(j).find("#dialog-type");var a=$(j).find("#dialog-param");var c=$(j).closest("tr").find('[name="paraName"]').text();if(!e.val()){$.ligerDialog.warn("请选择参数【"+c+"】所要绑定的对话框！",$lang.tip.warn);f=true;break;}else{if(!a.val()){$.ligerDialog.warn("请选择参数【"+c+"】对应的对话框返回值！",$lang.tip.warn);f=true;break;}}}if(f){return false;}var h=[];$("#paraInfo").find("tr").each(function(){var n=$(this),m=$("span[name='paraName']",n);if(!m||m.length==0){return true;}var k=$("span[name='paraType']",n),i=$("input[name='paraDesc']",n),p=$("[name='paraCt']",n),o={};o.paraName=m.text();o.paraType=k.text();o.paraDesc=i.val();o.paraCt=p.val();if($("#settingSpan",n).css("display")!="none"){var l=$("select[name='dialog-type']",n),q=$("select[name='dialog-param']",n);o.dialog=l.val();o.target=q.val();}h.push(o);});h=JSON2.stringify(h);$("textarea[name='argument']").val(h);$("#"+g).submit();}function showResponse(r){var data=eval("("+r+")");if(data.result){$.ligerDialog.success(data.message,$lang.tip.success,function(){window.location.href="list.ht";});}else{$.ligerDialog.warn(data.message,$lang.tip.errorMsg);}}function constructParamTable(f){var c=$("#para-txt table").clone();var a=$("tbody",c).empty();for(var b=0;b<f.para.length;b++){var e=f.para[b];var d=constructParamTr(e);a.append(d);}return c;}function constructParamTr(c){var b=$("#para-txt table tbody tr").clone();$("[name='paraName']",b).text(c.paraName);$("[name='paraType']",b).text(c.paraType);$("[name='paraDesc']",b).val(c.paraDesc);$("[name='paraCt']",b).val(c.paraCt);if(c.dialog){var a=$("#settingSpan",b);a.show();$("#dialog-type",a).find("option[value='"+c.dialog+"']").attr("selected","selected");dialogChange($("#dialog-type",a));$("#dialog-param",a).find("option[value='"+c.target+"']").attr("selected","selected");}return b;}