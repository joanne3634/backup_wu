var validateData=null;function initPage(a){initFirstStepLayout();initFirstStepTablesTree();if(!a){$("a.sbutton").hide();}$("#first-next").click(function(){if(scriptEditor){scriptEditor.save();}var b=validateFirstStepSetting(a);if(b.status){if(b.message){$.ligerDialog.error(b.message);}return;}if(!a){initSecondStepUpdate();}else{initSecondStepAdd();}});$("#second-prev").click(function(){$(".step-first").show();$(".step-second").hide();});}function initFirstStepLayout(){$("#firstLayout").ligerLayout({leftWidth:350,height:500,onHeightChanged:heightChanged,allowLeftResize:false});}function initFirstStepTablesTree(){var c=$("#dsName").val();if(!c){return;}var b={async:{enable:false},data:{key:{name:"name"},simpleData:{enable:true,idKey:"id",pIdKey:"pid",rootPId:"0"}},callback:{onDblClick:zTreeOnDblClick}};var a=__ctx+"/platform/system/jdbcDb/getTables.ht?dsName="+c;a=a.getNewUrl();$.ligerDialog.waitting("正在加载数据，请等待...");$.post(a,{},function(d){var e=transDataToZtreeFormat(d);tablesTree=$.fn.zTree.init($("#tablesTree"),b,e);$.ligerDialog.closeWaitting();});}function initFirstStep(a){$("#first-next").click(function(){if(!a){initStepSecondUpdate();}else{initStepSecondAdd();}});}function validateFirstStepSetting(a){var b={status:0,message:""};var c=$("#sysCustomDisplayForm").form();if(!c.handValidResult("#name")){b.status=1;}if(a){if(!c.handValidResult("#script")){b.status=2;}if($("[name='dsName']").val()==""){b.status=3;b.message="请选择数据源！";return b;}validateData=validateScript();if(!validateData.status){b.status=4;b.message=validateData.resultMsg;return b;}if(!validateData.supportSubSelect){b.status=5;b.message="脚本执行的结果必须能够作为子查询！";return b;}}return b;}function validateSecondStepSetting(a){var b={status:0,message:""};var d=$("#template").val();if(!d){b.status=1;b.message="请设置模板！";return b;}var c=$("#setting").val();if(!c){b.status=2;b.message="请设置模板参数！";return b;}return b;}function initSecondStepUpdate(){var a=$("#fieldSetting").val();if(!a){a=$("#fields").val();}initColumns($.parseJSON(a));var b=$("#conditionField").val();initConditions($.parseJSON(b));$(".step-first").hide();$(".step-second").show();}function initSecondStepAdd(){var a=validateData.sqlFields;initColumns(a);initConditions([]);$(".step-first").hide();$(".step-second").show();$("#fields").val(JSON2.stringify(a));}function validateScript(){var e=$("[name='dsName']").val();var a=$("[name='script']").val();var b=__ctx+"/platform/system/sysCustomDisplay/validateScript.ht";var d={dsName:e,script:a};var c;$.ajax({url:b,data:d,async:false}).done(function(f){c=f;});return c;}function templateChangeHandler(a){$("#conditionField").val("");$("#setting").val("");}function settingTemplate(){var b=$("#template").val();if(!b){$.ligerDialog.error("请先选择一个模板！");return;}var d=getAllSetting();$("#fieldSetting").val(JSON2.stringify(d.fieldSetting));$("#conditionField").val(JSON2.stringify(d.conditionField));var c=$.parseJSON($("#setting").val());var a=d.fieldSetting;if(!a){a=$.parseJSON($("#fields").val());}var e={fields:a,setting:c};openSettingTemplateDialog(e);}function openSettingTemplateDialog(e){var c=$("#template").find("option:selected").attr("setting");var a="dialogWidth=900px;dialogHeight=600px;help=0;status=0;scroll=0;center=1";var b=__ctx+c;b=b.getNewUrl();var d=window.showModalDialog(b,e,a);if(d){$("#setting").val(JSON2.stringify(d.setting));}}function customFormSubmit(q){var d=$("#id").val();var a=$("#name").val();var i=$("#script").val();var m=$("#scirptType").val();var n=$("#description").val();var h=$("#fieldSetting").val();var p=$("#setting").val();var e=$("#conditionField").val();var c=$("#dsName").val();var g=$("#dsAlias").val();var l=$("#template").val();var k=$("input[name='paged']:checked").val();var f=$("#pageSize").val();var o={id:d,name:a,description:n,script:i,scriptType:m,setting:p,fieldSetting:h,conditionField:e,dsName:c,dsAlias:g,template:l,paged:k,pageSize:f};var b=$('<form method="post" action="save.ht"></form>');var j=$("<input type='hidden' name='json'/>");j.val(JSON2.stringify(o));b.append(j);b.ajaxForm(q);b.submit();}function heightChanged(a){$("#tablesTree").height(a.middleHeight-90);}function zTreeOnDblClick(a,c,b){if(b.id=="table"||b.id=="view"||b.id=="0"){return;}if(b.isParent){return;}var d=b.name;var e=scriptEditor.getCursor();scriptEditor.replaceRange(d,e);}function transDataToZtreeFormat(e){var l=e.tables;var m=e.views;var a=[{name:"数据表",id:"table",pid:"0",type:1},{name:"视图",id:"view",pid:"0",type:2}];for(var f=0;f<l.length;f++){var o=l[f];var g={id:o.name,pid:"table",name:o.name,comment:o.comment,type:3};a.push(g);var c=o.columnList;for(var d=0;d<c.length;d++){var b=c[d];var k={id:b.tableName+"."+b.name,pid:b.tableName,name:b.name,comment:b.comment,type:5};a.push(k);}}for(var f=0;f<m.length;f++){var h=m[f];var n={id:h.name,pid:"view",name:h.name,comment:h.comment,type:4};a.push(n);var c=h.columnList;for(var d=0;d<c.length;d++){var b=c[d];var k={id:b.tableName+"."+b.name,pid:b.tableName,name:b.name,comment:b.comment,type:5};a.push(k);}}return a;}function changeDataSource(){initFirstStepTablesTree();}function treeSelect(m){if(!tablesTree){return;}var b=tablesTree.getSelectedNodes();var t="";switch(m){case 1:for(var h=0;h<b.length;h++){if(b[h].id=="table"||b[h].id=="view"||b[h].id=="0"){continue;}t+=" ,"+b[h].name;}if(t){t=t.substring(2);var n=scriptEditor.getCursor();scriptEditor.replaceRange(t,n);}break;case 2:var r=[];var s=[];for(var f=0;f<b.length;f++){var d=b[f];if(d.id=="table"||d.id=="view"||d.id=="0"){continue;}if(d.type==3||d.type==4){s.push(d.name);var c=d.children;var a=false;for(var h=0;h<c.length;h++){var e=c[h].id;var l=false;for(var g=0;g<b.length;g++){if(b[g].id==e){l=true;break;}}if(l==true){a=true;break;}}if(a==false){for(var h=0;h<c.length;h++){r.push(c[h].name);}}continue;}if(d.type==5||d.type==6){r.push(d.name);var q=d.getParentNode();var l=false;for(var g=0;g<b.length;g++){if(b[g].id==q.id){l=true;break;}}if(l==false){s.push(q.name);}continue;}}t="SELECT\n\t";var o=r.join(",\n\t")||"<选择的列>\n\t";t+=o;t+="\nFROM\n\t";var p=s.join(",\n\t")||"<选择的表>\n\t";t+=p;t+="\nWHERE\n\t<条件>";var n=scriptEditor.getCursor();scriptEditor.replaceRange(t,n);break;}}function initColumns(a){var b=$("#columnsTbl tbody").html("");for(var c=0;c<a.length;c++){var e=a[c];var d=constructColumnTr(e);b.append(d);}}function initConditions(g){if(!g){return false;}$("#conditionTbl tbody").html("");for(var e=0;e<g.length;e++){var l=g[e];var n=l.joinType;var a=l.name;var c=l.qualifiedName;var k=l.type;var h=l.comment;var d=l.cond;var m=l.value;var f=l.valueFrom;var b={joinType:n,name:a,qualifiedName:c,type:k,comment:h,operate:d,value:m,valueFrom:f};var j=constructConditionTr(b);$("#conditionTbl tbody").append(j);}}function constructColumnTr(i){var g=i.index;var h=i.type;var a=i.name;var c=i.qualifiedName;var j=i.label;var e=i.comment;if(!e){e=j;}var f=$("<td></td>");var m=$("<input></input>");m.attr("name","fieldCheckBox");m.attr("type","checkbox");f.append(m);$inputHidden=$("<input type='hidden'/>");$inputHidden.val(JSON2.stringify(i));f.append($inputHidden);var k=$("<td></td>");k.append(a);var b=$("<td style='width:80px;'></td>");var l=$("<input style='width:80px;'></input>");l.attr("name","fieldComment");l.val(e);b.append(l);var d=$("<tr></tr>");d.append(f);d.append(k);d.append(b);return d;}function selectCondition(){$("#columnsTbl input:[name='fieldCheckBox']:checked").each(function(){var i=$.parseJSON($(this).closest("tr").find("input[type='hidden']").val());var b=$(this).closest("tr").find("input[name='fieldComment']");var a=i.name;var h=i.type;var j=i.label;var f=i.index;var d=i.qualifiedName;var e=b.val();var c={joinType:"AND",name:a,qualifiedName:d,label:j,type:h,operate:"=",comment:e,value:"",valueFrom:1};var g=constructConditionTr(c);$("#conditionTbl tbody").append(g);});}function constructConditionTr(r){var u=r.joinType;var d=r.type;var x=r.name;var l=r.qualifiedName;var i=r.lebel;var a=r.comment;var k=r.operate;var p=r.value;var j=r.valueFrom;var q=function(z,y,B){if(!B){B=y;}var A=$("<option></option");A.text(B);A.val(y);if(z==y){A.attr("selected","selected");}return A;};var m=$("<td></td>");var v=$("<select name='conditionJoinType'></select>");v.append(q(u,"AND"));v.append(q(u,"OR"));m.append(v);$hiddenInput=$("<input type='hidden'/>");$hiddenInput.val(JSON2.stringify(r));m.append($hiddenInput);var g=$("<td></td>");g.append(x);var t=$("<td></td>");var s=$("<select name='conditionOperate'></select>");s.css("width","100%");switch(d){case"varchar":s.append(q(k,"="));s.append(q(k,"likeEnd"));s.append(q(k,"like"));break;case"number":s.append(q(k,"="));s.append(q(k,">"));s.append(q(k,"<"));s.append(q(k,">="));s.append(q(k,"<="));break;case"int":s.append(q(k,"="));s.append(q(k,">"));s.append(q(k,"<"));s.append(q(k,">="));s.append(q(k,"<="));break;default:s.append(q(k,"="));s.append(q(k,">="));s.append(q(k,"<="));s.append(q(k,"between"));}t.append(s);var b=$("<td style='width:80px;'></td>");var e=$("<input style='width:80px;' name='conditionComment' type='text'/>");e.val(a);b.append(e);var o=$("<td></td>");var n=$("<select name='conditionValueFrom' onchange='selectValueFrom(this)'></select>");n.append(q(j,1,"输入"));n.append(q(j,2,"固定值"));n.append(q(j,3,"脚本"));o.append(n);var c=$("<td style='width:150px;'></td>");$a=$("<a style='display:none;' href='#' name='btnScript' class='link var' title='常用脚本' onclick='selectScript(this)'>常用脚本</a>");var f;if(j==1){f=$("<input class='hide' name='conditionValue' type='text'/>");f.attr("readonly","readonly");}else{if(j==2){f=$("<input style='width:150px;' name='conditionValue' type='text'/>");}else{$a.show();f=$("<textarea style='width:150px;' name='conditionValue'></textarea>");}}f.val(p);c.append($a);c.append(f);var h=$("<td></td>");var w=$("<a onclick='delConditionTr(this)'>删除</a>");w.attr("href","#");w.addClass("link del");h.append(w);$tr=$("<tr></tr>");$tr.append(m);$tr.append(g);$tr.append(t);$tr.append(b);$tr.append(o);$tr.append(c);$tr.append(h);return $tr;}function delConditionTr(a){$(a).closest("tr").remove();}function getAllSetting(){var b={fieldSetting:new Array(),conditionField:new Array()};var a=getFieldSetting();b.fieldSetting=a;var c=getConditionSetting();b.conditionField=c;return b;}function getFieldSetting(){var a=[];$("#columnsTbl input:[type='hidden']").each(function(){$this=$(this);var b=$.parseJSON($this.val());var c=$this.closest("tr").find("input[name='fieldComment']").val();b.comment=c;a.push(b);});return a;}function getConditionSetting(){var a=[];$("#conditionTbl input[type='hidden']").each(function(){var h=$(this);var d=h.closest("tr");var g=$.parseJSON(h.val());var f=d.find("select:[name='conditionJoinType']").val();var b=d.find("select:[name='conditionOperate']").val();var c=parseInt(d.find("select:[name='conditionValueFrom']").val());var e=d.find("[name='conditionValue']").val();var i=d.find("input:[name='conditionComment']").val();g.joinType=f;g.operate=b;g.valueFrom=c;g.value=e;g.comment=i;g.valueFrom=c;a.push(g);});return a;}function selectValueFrom(e){var c=$(e).closest("tr");var d=c.find("a:[name='btnScript']");d.hide();var b=$(e).val();var a;if(b==1){a=$("<input class='hide' type='text'/>");a.attr("readonly","readonly");}else{if(b==2){a=$("<input style='width:150px;' type='text'/>");}else{d.show();a=$("<textarea></textarea>");a.css("width","150px");}}a.attr("name","conditionValue");c.find("[name='conditionValue']").replaceWith(a);}function selectScript(b){var a=$(b);var c=a.next()[0];ScriptDialog({callback:function(d){$.insertText(c,d);}});}