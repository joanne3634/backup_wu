Permission=function(){this.FieldsPermission=[];this.SubTablePermission=[];this.SubTableFilePermission=[];this.subTableShows=[];this.Opinion=[];this.getDefaultPermission=function(c,b){var a={"title":c,"memo":b,"read":{"type":"everyone","id":"","fullname":""},"write":{"type":"everyone","id":"","fullname":""},"required":{"type":"everyone","id":"","fullname":""}};return a;};this.loadPermission=function(a,b){var c={tableId:a,formKey:b};this.load("getPermissionByTableFormKey.ht",c);};this.loadByNode=function(a,d,b){var c={actDefId:a,nodeId:d,formKey:b};this.load("getPermissionByFormNode.ht",c);};this.loadByActDefId=function(a,b){var c={actDefId:a,formKey:b};this.load("getPermissionByActDefId.ht",c);};this.load=function(b,c){var a=this;$.ligerDialog.waitting("正在加载表单权限,请稍后...");$.post(b,c,function(g){$.ligerDialog.closeWaitting();var j=g["field"];var n=g["table"];var m=g["opinion"];var d=g["tableShow"];if(j!=undefined&&j!=""){a.FieldsPermission=j;var f=a.getPermission(a.FieldsPermission,"field");$("#fieldPermission").empty();$("#fieldPermission").append(f);a.initStatus("fieldPermission");}if(n!=undefined&&n!=""){a.SubTablePermission=n;a.setSubTableFilePermission(n);var e=a.getPermission(a.SubTablePermission,"subtable");$("#tablePermission").empty();$("#tablePermission").append(e);for(var h=0;h<a.SubTablePermission.length;h++){var k=a.SubTablePermission[h];a.initStatus("tableId_"+k.tableId);}}else{$("#tablePermission").closest("table").hide();}if(m!=undefined&&m!=""){a.Opinion=m;var l=a.getPermission(a.Opinion,"opinion");$("#opinionPermission").empty();$("#opinionPermission").append(l);a.initStatus("opinionPermission");}else{$("#opinionPermission").closest("table").hide();}if(d!=undefined&&d!=""){a.subTableShows=d;a.initSubTableRadio(a.subTableShows);}});a.handChange();a.handClick();};this.initSubTableRadio=function(f){for(var d=0;d<f.length;d++){var c=f[d];var e="#tableId_"+c.tableId;var a=$(e);var b="radio_"+c.tableId;$('input:radio[name="'+b+'"]',a).each(function(){var g=$(this).val();if(g==c.show){$(this).attr("checked","checked");}else{$(this).attr("checked",false);}});}};this.initStatus=function(b){var a=this;$("tr","#"+b).each(function(){var j=$(this);var l=$("select.r_select",j);var f=$("select.w_select",j);var k=$("select.b_select",j);var h=l.attr("permissonType");var d=f.attr("permissonType");var c=k.attr("permissonType");l.val(h);f.val(d);k.val(c);var i=$("span[name='r_span']",j);var e=$("span[name='w_span']",j);var g=$("span[name='b_span']",j);a.showSpan(h,i);a.showSpan(d,e);a.showSpan(c,g);});};this.handChange=function(){var a=this;$("#fieldPermission,#tablePermission,#opinionPermission").delegate("select.r_select,select.w_select,select.b_select","change",function(){var e=$(this);var b=e.next();a.showSpan(e.val(),b);var h=e.parents("tr");var i=e.parents("tbody");var f="read";if(e.attr("class")=="r_select"){f="read";}else{if(e.attr("class")=="w_select"){f="write";}else{if(e.attr("class")=="b_select"){f="required";}}}var j=i.children().index(h);var g=h.attr("type");var k=e.val();a.changePermission(g,j,f,k,"","");var d=$("input:text",b);var c=$("input:hidden",b);d.val("");c.val("");});};this.changePermission=function(f,a,h,d,c,g){if(a==-1){return;}var b=[];switch(f){case"field":b=this.FieldsPermission;break;case"subtable":b=this.SubTableFilePermission;if(a>0){a=a-1;}break;case"opinion":b=this.Opinion;break;}var e=b[a];e[h]["type"]=d;e[h]["id"]=c;e[h]["fullname"]=g;};this.handClick=function(){var a=this;$("#fieldPermission,#tablePermission,#opinionPermission").delegate("a.link-get","click",function(){var g=$(this);var h=g.prev();var b=h.prev();var f=g.parent().prev();var d=f.val();var i=function(l,o){var m=g.parents("tr");var k=g.parents("tbody");var p=g.attr("mode");var j=k.children().index(m);var n=m.attr("type");a.changePermission(n,j,p,d,l,o);h.val(o);b.val(l);};var c=b.val();var e=h.val();switch(d){case"user":UserDialog({selectUserIds:c,selectUserNames:e,callback:i});break;case"role":RoleDialog({ids:c,names:e,callback:i});break;case"org":case"orgMgr":OrgDialog({ids:c,names:e,callback:i});break;case"pos":PosDialog({ids:c,names:e,callback:i});break;}});};this.showSpan=function(a,b){switch(a){case"user":case"role":case"org":case"orgMgr":case"pos":b.show();break;case"everyone":case"none":b.hide();break;}};this.getPermission=function(b,f){var h=new StringBuffer();if(f=="subtable"){for(var d=0;d<b.length;d++){var g=b[d];var k='<tr><td colspan="4">';k+='<table id="tableId_'+g.tableId+'" mainTableId="tableId_'+g.mainTableId+'" cellpadding="1" cellspacing="1" class="table-grid" style="margin-top: 5px;" name="subTablePermission" value="'+g.title+'">';k+='<tr><th colspan="4">'+g.memo+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" value="w" name="radio_'+g.tableId+'" id="radio_'+g.tableId+'" checked="checked" ><label for="SubtableShow">编辑</label>';k+='&nbsp;&nbsp;<input type="radio" value="b" name="radio_'+g.tableId+'" id="radio_'+g.tableId+'"><label for="SubtableShow">必填</label>';k+='&nbsp;&nbsp;<input type="radio" value="r" name="radio_'+g.tableId+'" id="radio_'+g.tableId+'"><label for="SubtableShow">只读</label>';k+='&nbsp;&nbsp;<input type="radio" value="y" name="radio_'+g.tableId+'" id="radio_'+g.tableId+'"><label for="SubtableShow">隐藏</label></th></tr>';var a=g.subField;for(var c=0;c<a.length;c++){var l=a[c];var e=this.getHtml(l,f);k+=e;}k+="</table></td></tr>";h.append(k);}}else{for(var d=0;d<b.length;d++){var l=b[d];var e=this.getHtml(l,f);h.append(e);}}return h.toString();};this.setSubTableFilePermission=function(e){for(var d=0;d<e.length;d++){var f=e[d];var c=f.subField;for(var b=0;b<c.length;b++){var a=c[b];this.SubTableFilePermission.push(a);}}};this.getHtml=function(k,e){var a="";if(e=="field"){var c=k.rpost?' checked="checked" ':"";a='<td><input name="rpost" type="checkbox" '+c+"/></td>";}var j=['<tr type="#permissionType" tableId="'+k.tableId+'" mainTableId="'+k.mainTableId+'" tableName="'+k.tableName+'" mainTableName="'+k.mainTableName+'">',"<td>#desc</td>",this.getHtmlTd("r","read",e),this.getHtmlTd("w","write",e),this.getHtmlTd("b","required",e),a,"</tr>"];permissionTr=j.join("");var d=k.required,i="none",h="",g="";if(d!=undefined&&d!=""){i=d.type;h=d.id;g=d.fullname;}var b=permissionTr.replaceAll("#name",k.title).replaceAll("#desc",k.memo).replaceAll("#r_type",k.read.type).replaceAll("#w_type",k.write.type).replaceAll("#b_type",i).replaceAll("#R_ID",k.read.id).replaceAll("#W_ID",k.write.id).replaceAll("#B_ID",h).replaceAll("#R_FullName",k.read.fullname).replaceAll("#W_FullName",k.write.fullname).replaceAll("#B_FullName",g).replaceAll("#permissionType",e);return b;};this.getHtmlTd=function(a,b,d){var c=a.toUpperCase();var e="";if(d=="subtable"){e=' width="25%" ';}var f=["<td"+e+">",'<select class="',a,'_select"  permissonType="#',a,'_type" name="#name"  >','<option value="user">用户</option>','<option value="role">角色</option>','<option value="org">组织</option>','<option value="orgMgr">组织负责人</option>','<option value="pos">岗位</option>','<option value="everyone">所有人</option>','<option value="none">无</option>',"</select>",'<span name="',a,'_span">','<input  type="hidden"  value="#',c,'_ID"/>','<input  type="text"  readonly value="#',c,'_FullName"/>','<a href="#" class="link-get" mode="',b,'" ><span class="link-btn">选择</span></a>',"</span>","</td>"];return f.join("");};this.getPermissionJson=function(){var b={field:this.FieldsPermission,subtable:this.SubTableFilePermission,opinion:this.Opinion,subTableShows:this.subTableShows};var a=JSON2.stringify(b);return a;};this.addPermission=function(b,a,c){var d=this.isPermissionExist(b,c);if(!d){var e=this.getDefaultPermission(b,a);c.push(e);return true;}return false;};this.isPermissionExist=function(a,d){for(var c=0;c<d.length;c++){var e=d[c];var b=e.title.toLocaleLowerCase();a=a.toLocaleLowerCase();if(b==a){return true;}}return false;};this.getPermissionByName=function(a,d){for(var c=0;c<d.length;c++){var e=d[c];var b=e.title.toLocaleLowerCase();a=a.toLocaleLowerCase();if(b==a){return e;}}return null;};this.addOpinion=function(b,a){b=b.replace(/opinion:/g,"");var c=this.addPermission(b,a,this.Opinion);var d=this.getPermission(this.Opinion,"opinion");$("#opinionPermission").empty().append(d);this.initStatus("opinionPermission");return c;};this.replaceOpinion=function(e,b,a){var d=this.getPermissionByName(e,this.Opinion);d["title"]=b;d["memo"]=a;var c=this.getPermission(this.Opinion,"opinion");$("#opinionPermission").empty().append(c);this.initStatus("opinionPermission");};this.syncOpinion=function(f){if(f.length==0){this.Opinion=[];}else{for(var d=0;d<this.Opinion.length;d++){var c=0,g=this.Opinion[d].title.toLocaleLowerCase();for(var b=0;b<f.length;b++){var a=$(f[b]).attr("name").toLocaleLowerCase().replace(/opinion:/g,"");if(g!=a){this.addOpinion(a,$(f[b]).attr("opinionname"));}else{c=1;f.splice(b,1);}}if(c==0){this.Opinion.splice(d,1);}}}if(this.Opinion.length!=0){var e=this.getPermission(this.Opinion,"opinion");$("#opinionPermission").empty().append(e);$("#opinionPermission").closest("table").show();this.initStatus("opinionPermission");}};this.setAllPermission=function(){this.readPermission(this.FieldsPermission,"field");this.readPermission(this.SubTablePermission,"subtable");this.readPermission(this.Opinion,"opinion");};this.readPermission=function(d,f){if(f=="field"){this.FieldsPermission=this.readPermissionByObj("#fieldPermission",f);}else{if(f=="subtable"){var c=d;this.subTableShows=this.readTablePermission(c,f);for(var b=0;b<c.length;b++){var e=c[b];var h="#tableId_"+e.tableId;var g=this.readPermissionByObj(h,f);if(b==0){this.SubTableFilePermission=g;}else{for(var a=0;a<g.length;a++){this.SubTableFilePermission.push(g[a]);}}}}else{this.Opinion=this.readPermissionByObj("#opinionPermission",f);}}};this.readPermissionByObj=function(d,c){var a=$(d);var b=[];$("tr",a).each(function(l){if(c=="subtable"&&l==0){return true;}var m=$(this);var o=m.attr("tableId");var h=m.attr("mainTableId");var j=m.attr("tableName");var e=m.attr("mainTableName");var v=m.children().first().text();var q=$(".r_select",m);var y=$("[name=r_span]",m);var u=$("input:hidden",y).val();var x=$("input:text",y).val();var s=$(".w_select",m);var w=$("[name=w_span]",m);var r=$("input:hidden",w).val();var t=$("input:text",w).val();var A=$(".b_select",m);var n=$("[name=b_span]",m);var z=$("input:hidden",n).val();var g=$("input:text",n).val();var p=$("[name=rpost]",m);var f=false;if(p.length>0){f=p.is(":checked");}var i=q.attr("name");var k={"title":i,"memo":v,"tableId":o,"mainTableId":h,"tableName":j,"mainTableName":e,"read":{"type":q.val(),"id":u,"fullname":x},"write":{"type":s.val(),"id":r,"fullname":t},"required":{"type":A.val(),"id":z,"fullname":g},"rpost":f};b.push(k);});return b;};this.readTablePermission=function(g,d){var a=[];for(var e=0;e<g.length;e++){var i=g[e];var j="#tableId_"+i.tableId;var c=$(j);var b="radio_"+i.tableId;var f=$('input:radio[name="'+b+'"]:checked',c).val();var h={"title":i.title,"memo":i.memo,"tableId":i.tableId,"mainTableId":i.mainTableId,"tableName":i.tableName,"mainTableName":i.mainTableName,"show":f};a.push(h);}return a;};};