var wsTree,menu,menu_root,wsHeight,varHeight,varTree,_seq=1;$(function(){$("#webLayout").ligerLayout({leftWidth:350,height:"100%",allowLeftResize:false});$("#wsdlTxt").bind("focus",function(a){var b="请输入地址查询";$("#wsdlTxt")[0].defaultValue=b;if($("#wsdlTxt").val()==b){$("#wsdlTxt").val("");}}).bind("blur",function(){var a=$("#wsdlTxt").val();if($.trim(a).length<1){$("#wsdlTxt").val($("#wsdlTxt")[0].defaultValue);}});varHeight=$("#varLayout").height();loadVarTree();$(".drag-span").dragspan({buddy:"varTree",treeDropHandler:function(a,b){a=$(a);a.text(b.varKey);a.attr("varId",b.id);a.closest("tr").next().find("td").html(b.type);}});$(".table-detail").delegate("select[name=bindingType]","change",function(){var a=$(this).closest("table");$("tr[bingdingType]",a).hide();$("tr[bingdingType="+$(this).val()+"]",a).show("fast");});$("#dataFormSave").click(function(){saveWebserviceSet();});if(bpmNodeWebServiceDocument){parseNodeWebservice(bpmNodeWebServiceDocument);}});function loadVarTree(){var setting={async:{enable:false},view:{selectedMulti:false},edit:{drag:{prev:true,inner:true,next:true,isMove:true},enable:true,showRemoveBtn:false,showRenameBtn:false}};var url=__ctx+"/platform/bpm/bpmDefVar/getTree.ht";var params={defId:defId};$.post(url,params,function(result){var json=eval("("+result+")");varStruTree=$.fn.zTree.init($("#varTree"),setting,json);varStruTree.expandAll(true);$("#varTree").height(varHeight-20);});}function parseNodeWebservice(v){var v=eval("("+v+")");for(var i=0,c;c=v[i++];){addMethodNode(c,true);}}function saveWebserviceSet(){var json=[];$("fieldset[zone=method]").each(function(){var me=$(this),methodInfo=me.data("methodInfo"),inputDiv=$("div[var=inputTreeEdit]",me),ouputDIv=$("div[var=outputTreeEdit]",me),inputTable=$(".table-detail[zone=binding]",inputDiv),outputTable=$(".table-detail[zone=binding]",ouputDIv);obj={};if(methodInfo){obj.inputParams=methodInfo.inputParams.children;obj.outputParams=methodInfo.outputParams.children;}obj.url=$("input[var=invokeUrl]",me).val();if(!obj.url){return true;}obj.serviceName=$("input[var=serviceName]",me).val();obj.soapaction=$("input[var=soapaction]",me).val();obj.method=$("td[var=method]",me).text();obj.namespace=$("td[var=namespace]",me).text();obj.inputs=[];for(var i=0,c;c=inputTable[i++];){var param={};param.name=$("span[var=name]",c).text();param.fullpath=$("input[var=fullpath]",c).val();param.soapType=$("td[var=type]",c).text();param.bindingType=$("select[name=bindingType]",c).val();var binding=$("[name='defValue"+param.bindingType+"']",c);param.bindingVal=binding.val()?binding.val():binding.text();param.bindingVal=param.bindingVal.jsonEscape();param.javaType=javaType=$("[name=javaType]",c).text();obj.inputs.push(param);}obj.outputs=[];for(var i=0,c;c=outputTable[i++];){var param={};param.name=$("span[var=name]",c).text();param.fullpath=$("input[var=fullpath]",c).val();param.soapType=$("td[var=type]",c).text();param.bindingType=$("select[name=bindingType]",c).val();var binding=$("[name='defValue"+param.bindingType+"']",c);param.bindingVal=binding.val()?binding.val():binding.text();param.bindingVal=param.bindingVal.jsonEscape();param.javaType=javaType=$("[name=javaType]",c).text();obj.outputs.push(param);}json.push(obj);});json=JSON2.stringify(json);var url=__ctx+"/platform/bpm/bpmNodeWebService/save.ht";$.post(url,{setId:bpmNodeWebServiceSetId,json:json,nodeId:nodeId,actDefId:actDefId},function(d){var result=eval("("+d+")");if(result.success){$.ligerDialog.success(result.msg,"提示信息",function(){window.close();});}else{$.ligerDialog.error(result.msg,"出错了");}});}var addMethodNode=function(t,depParse){var params={wsdlUrl:t.url,nodeName:t.method,serviceName:t.serviceName};var setting={view:{addDiyDom:function(treeId,treeNode){var type=treeNode.type;var aObj=$("#"+treeNode.tId+"_a");aObj.append('<span style="margin-left:5px;">('+type+")</span>");},selectedMulti:false},check:{enable:true,chkboxType:{"Y":"","N":""}},callback:{beforeCheck:function(treeId,treeNode){if(!treeNode.type){return true;}if(treeNode.checked){if(confirm("是否取消当前参数["+treeNode.name+"]的绑定配置?")){var $div=$("#"+treeId+"-edit");if($div.length<1){return;}$("#"+treeNode.name+"_"+rep_list(treeNode.type)+"-edit",$div).remove();return true;}else{return false;}}return true;},onCheck:function(event,treeId,treeNode){var $div=$("#"+treeId+"-edit");if($div.length<1){return;}if(!treeNode.type){return;}if(treeNode.checked){$("#"+treeNode.tId+"_a").click();}else{var $editTable=$("#"+treeNode.tId+"-edit",$div);$editTable.remove();}},onClick:function(event,treeId,treeNode){if(!treeNode.checked){return;}var $div=$("#"+treeId+"-edit");cloneBindingTable(treeNode,$div);}}};$.ajax({type:"POST",url:__ctx+"/platform/bpm/bpmNodeWebService/get.ht",data:params,dataType:"json",success:function(result){var json=eval("("+result+")");if(!json.success){$.ligerDialog.warn(json.msg,"提示信息");return false;}var operatorField=$("#editField [zone=method]").clone(true,true);$(operatorField).data("methodInfo",json);$("[var=wsdl]",operatorField).html(json.wsdl);$("[var=method]",operatorField).html(json.method);$("[var=namespace]",operatorField).html(json.namespace);$("[var=soapaction]",operatorField).val(json.soapaction);$("[var=invokeUrl]",operatorField).val(json.invokeUrl);$("[var=serviceName]",operatorField).val(params.serviceName);$("[var=del]",operatorField).unbind();$("[var=del]",operatorField).click(function(e){$.ligerDialog.confirm("删除当前方法["+json.method+"]?","提示信息",function(rtn){if(rtn){operatorField.fadeOut(500,function(){$(this).remove();});}});});var $inputTreeUl=$("[var=inputTree]",operatorField);$inputTreeUl.attr("id","inputtree"+(_seq++));$("[var=inputTreeEdit]",operatorField).attr("id",$inputTreeUl.attr("id")+"-edit");var inputParamsTree=$.fn.zTree.init($inputTreeUl,setting,json.inputParams);var $outputTreeUl=$("[var=outputTree]",operatorField);$outputTreeUl.attr("id","outputtree"+(_seq++));$("[var=outputTreeEdit]",operatorField).attr("id",$outputTreeUl.attr("id")+"-edit");var outputParamsTree=$.fn.zTree.init($outputTreeUl,setting,json.outputParams);operatorField.hide();$("#webservice").prepend(operatorField);operatorField.fadeIn();inputParamsTree.expandAll(true);outputParamsTree.expandAll(true);setTimeout(function(){if(depParse){var inputs=t.inputs,outputs=t.outputs;for(var i=0,c;c=inputs[i++];){cloneBindingTable(c,$("[var=inputTreeEdit]",operatorField),1);}for(var i=0,c;c=outputs[i++];){cloneBindingTable(c,$("[var=outputTreeEdit]",operatorField),1);}}},200);},error:function(msg){$.ligerDialog.error("出错了！","提示信息");return;}});};function getFullPath(c){if(c.fullpath){return c.fullpath;}var e=c.level,a=[c.name];while(e>1){c=c.getParentNode();e=c.level;a.push(c.name);}var d,b=[];while(d=a.pop()){b.push(d);}return b.join(".");}function rep_list(a){if(!a){return a;}return a.replace(/[\{|\}]/g,"_");}function cloneBindingTable(a,e,f){if(e.length<1){return;}$("table",e).hide();if(!a.type&&!a.soapType){return;}var b=$("#"+a.name+"_"+rep_list(a.type)+"-edit",e),c=e.attr("var");if(b.length<1){b=$("#editField [zone=binding]").clone(true,true);$("input[var=fullpath]",b).val(getFullPath(a));$("span[var=name]",b).text(a.name);if(f){$("[var=type]",b).html(a.soapType);$("select[name=bindingType]",b).val(a.bindingType);b.attr("id",a.name+"_"+rep_list(a.soapType)+"-edit");}else{$("[var=type]",b).html(a.type);b.attr("id",a.name+"_"+rep_list(a.type)+"-edit");}if("outputTreeEdit"==c){$("a.tipinfo",b).removeClass("hidden");$("select[name=bindingType]",b).find("option").each(function(){if($(this).val()=="1"){$(this).remove();}});}e.append(b);b.hide();}b.fadeIn(function(){if(f){$("select[name=bindingType]",b).trigger("change");setTimeout(function(){var j=$("[name='defValue"+a.bindingType+"']",b);if(a.bindingType==1){j.val(a.bindingVal);}else{j.text(a.bindingVal.jsonUnescape());}$("[name=javaType]",b).text(a.javaType);var i=$("ul",e.siblings()).attr("id"),h=$.fn.zTree.getZTreeObj(i);if(h){var g=function(k){return(k.name==a.name&&k.type==a.soapType);};var d=h.getNodesByFilter(g,true);if(d){h.checkNode(d,true,true);}}},200);}});}function getByWsdlUrl(){var a=$("#wsdlTxt").val();if($.trim(a).length<1||$("#wsdlTxt")[0].defaultValue==a){$.ligerDialog.warn("还没有填写webService地址!","提示信息");return;}wsHeight=$("#wsLayout").height();$("#treeReFresh").click(function(){loadWsTree();});$("#treeExpand").click(function(){wsTree.expandAll(true);});$("#treeCollapse").click(function(){wsTree.expandAll(false);});loadWsTree();$("#wsTree").height(wsHeight-65);}function loadWsTree(){var setting={data:{key:{name:"name",wsdlUrl:"wsdlUrl"}},view:{selectedMulti:false},callback:{onDblClick:zTreeOnDblClick}};$.ligerDialog.waitting("正在查询中,请稍候...");$.ajax({type:"POST",url:__ctx+"/platform/bpm/bpmNodeWebService/getTreeData.ht",data:{"wsdlUrl":$("#wsdlTxt").val()},dataType:"json",success:function(result){$.ligerDialog.closeWaitting();var json=eval("("+result+")");wsTree=$.fn.zTree.init($("#wsTree"),setting,json);wsTree.expandAll(true);},error:function(msg){$.ligerDialog.closeWaitting();$.ligerDialog.error("输入WebService地址是否错误或者链接异常，请检查！","提示信息");return;}});}function zTreeOnDblClick(c,b,a){wsTree.selectNode(a);if(a.level==0){return;}else{if(wsTree==null){$.ligerDialog.warn("请先查询出webservice的方法","提示信息");return;}var a=getSelectNode();if(a&&a.level==0){$.ligerDialog.warn("请选择webservice的方法","提示信息");return;}a.serviceName=a.getParentNode().name;a.url=a.getParentNode().wsdlUrl;a.method=a.name;addMethodNode(a);}}function getSelectNode(){wsTree=$.fn.zTree.getZTreeObj("wsTree");var a=wsTree.getSelectedNodes();return a[0];}function closeWin(){$.ligerDialog.confirm("是否关闭当前窗口?","提示信息",function(a){if(a){window.close();}});}