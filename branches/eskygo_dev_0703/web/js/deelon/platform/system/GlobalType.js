var globalMenu=new GlobalMenu();var treeNodelickAble=true;var menu;$(function(){changeType();loadTree(catId);layout();});function changeType(){$("#dkey").change(function(){var a=$(this);catId=a.val();loadTree(catId);});}function clickHandler(b){var a=b.text;var c=getSelectNode();if(a=="增加分类"){addNode();}else{if(a=="导出"){exportNode();}else{if(a=="导入"){importNode();}else{if(a=="排序"){sortNode();}else{if(a=="删除"){delNode();}else{if(a=="刷新"){reAsyncChild(c);}}}}}}}function refresh(){loadTree(catId);}function refreshNode(a){if(a){curSelectNode.isParent=true;glTypeTree.selectNode(curSelectNode);reAsyncChild(curSelectNode);}else{loadTree(catId);}}function layout(){$("#layout").ligerLayout({leftWidth:210,onHeightChanged:heightChanged,allowLeftResize:false});var a=$(".l-layout-center").height();$("#glTypeTree").height(a-60);}function heightChanged(a){$("#glTypeTree").height(a.middleHeight-60);}var glTypeTree;var expandByDepth=0;function loadTree(b){var a={data:{key:{name:"typeName"},simpleData:{enable:true,idKey:"typeId",pIdKey:"parentId"}},view:{selectedMulti:false},edit:{drag:{prev:dropEnable,inner:dropEnable,next:dropEnable},enable:true,showRemoveBtn:false,showRenameBtn:false},async:{enable:true,url:__ctx+"/platform/system/globalType/getByParentId.ht",autoParam:["typeId=parentId"],otherParam:{catId:b}},callback:{onClick:zTreeOnClick,onRightClick:zTreeOnRightClick,beforeClick:zTreeBeforeClick,beforeDrop:beforeDrop,onDrop:onDrop,onAsyncSuccess:zTreeOnAsyncSuccess}};glTypeTree=$.fn.zTree.init($("#glTypeTree"),a);}var curSelectNode;function zTreeOnClick(c,e,d){curSelectNode=d;var b=d.typeId;if(catId==b){return;}var a=__ctx+"/platform/system/globalType/edit.ht?typeId="+b;$("#listFrame").attr("src",a);}function zTreeOnAsyncSuccess(b,d,c,e){glTypeTree=$.fn.zTree.getZTreeObj("glTypeTree");var a=glTypeTree.getNodeByParam("typeId",catId);if(a&&a.typeId==catId){a.isRoot=1;a.icon=__ctx+"/styles/default/images/icon/root.png";glTypeTree.updateNode(a);}if(curSelectNode){curSelectNode=glTypeTree.getNodeByParam("typeId",curSelectNode.typeId);glTypeTree.selectNode(curSelectNode);}}function dropEnable(c,a,b){if(!b){return false;}if(b.isRoot){return false;}return true;}function beforeDrop(c,b,d,a){if(!b){return false;}if(d.isRoot){return false;}return true;}function onDrop(a,f,e,g,i){if(g==null||g==undefined){return;}var h=g.typeId;var c=e[0].typeId;var b=__ctx+"/platform/system/globalType/move.ht";var d={targetId:h,dragId:c,moveType:i};$.post(b,d,function(j){if(i=="inner"){reAsyncChild(g);}});}function reAsyncChild(b){var a=b.typeId;if(a==catId){loadTree(catId);}else{glTypeTree=$.fn.zTree.getZTreeObj("glTypeTree");glTypeTree.reAsyncChildNodes(b,"refresh",false);}treeNodelickAble=true;}function zTreeBeforeClick(c,b,a){return treeNodelickAble;}function sortType(c,b){var a=__ctx+"/platform/system/globalType/sort.ht";var d={typeIds:b};$.post(a,d,function(){reAsyncChild(c);treeNodelickAble=true;});}function swapNode(c,d){var b=c.typeId;var a=d.typeId;c.typeId=a;d.typeId=b;}function sortTreeNode(d){var a=d.getParentNode();var b=a.children;var c="";$.each(b,function(e,f){c+=f.typeId+",";});if(c.length>0){c=c.substring(0,c.length-1);}if(c.length==0){return;}sortType(a,c);}function addHoverDom(f,k){var c=k.getNextNode();var d=k.getPreNode();var e=$("#"+k.tId+"_span");if(d){if($("#upBtn_"+k.id).length>0){return;}var b="<button  type='button' class='link-sortUp' id='upBtn_"+k.id+"' title='向前' ></button>";e.append(b);var h=$("#upBtn_"+k.id);h.bind("click",function(){treeNodelickAble=false;swapNode(k,d);sortTreeNode(k);});}if(c){if($("#downBtn_"+k.id).length>0){return;}var i="<button  type='button' class='link-sortDown' id='downBtn_"+k.id+"' title='向后' ></button>";e.append(i);var j=$("#downBtn_"+k.id);j.bind("click",function(){treeNodelickAble=false;swapNode(k,c);sortTreeNode(k);});}if(d){if($("#topBtn_"+k.id).length>0){return;}var a="<button  type='button' class='link-sortTop' id='topBtn_"+k.id+"' title='最前' ></button>";e.append(a);var m=$("#topBtn_"+k.id);m.bind("click",function(){treeNodelickAble=false;var n=k.getParentNode();var o=n.children;var p=o[0];swapNode(k,p);sortTreeNode(k);});}if(c){if($("#bottomBtn_"+k.id).length>0){return;}var l="<button  type='button' class='link-sortBottom' id='bottomBtn_"+k.id+"' title='最后' ></button>";e.append(l);var g=$("#bottomBtn_"+k.id);g.bind("click",function(){treeNodelickAble=false;var n=k.getParentNode();var o=n.children;var p=o[o.length-1];swapNode(k,p);sortTreeNode(k);});}}function removeHoverDom(b,a){$("#upBtn_"+a.id).unbind().remove();$("#downBtn_"+a.id).unbind().remove();$("#topBtn_"+a.id).unbind().remove();$("#bottomBtn_"+a.id).unbind().remove();}function zTreeOnRightClick(c,b,a){if(menu){menu.hide();}if(a){glTypeTree.selectNode(a);menu=globalMenu.getMenu(a,clickHandler);if(menu){menu.show({top:c.pageY,left:c.pageX});}}}function treeExpandAll(a){glTypeTree=$.fn.zTree.getZTreeObj("glTypeTree");glTypeTree.expandAll(a);}function addNode(){if(curSelectNode){var c=curSelectNode.typeId;var a=0;if(curSelectNode.isRoot){a=1;}var b=__ctx+"/platform/system/globalType/edit.ht?parentId="+c+"&isRoot="+a;$("#listFrame").attr("src",b);}}function exportNode(){var c=$("#dkey").val();var a=getSelectNode();if(a){var b=a.typeId;window.location.href="exportXml.ht?typeId="+b+"&catId="+c;}}function importNode(){var d=getSelectNode();var g=$("#dkey").val();if(d){var a=d.typeId;var b=__ctx+"/platform/system/globalType/import.ht";var f={typeId:a,catId:g};var e=550;var j=250;var h=$.extend({},{dialogWidth:e,dialogHeight:j,help:0,status:0,scroll:0,center:1});var c="dialogWidth="+h.dialogWidth+"px;dialogHeight="+h.dialogHeight+"px;help="+h.help+";status="+h.status+";scroll="+h.scroll+";center="+h.center;b=b.getNewUrl();var i=window.showModalDialog(b,f,c);if(!i){reAsyncChild(d);}}}function sortNode(){var c=getSelectNode();var d=c.typeId;var b=__ctx+"/platform/system/globalType/sortList.ht?parentId="+d;var a="dialogWidth:600px;dialogHeight:300px";b=b.getNewUrl();var e=window.showModalDialog(b,"",a);reAsyncChild(c);}function delNode(){var a=getSelectNode();var b=a.typeId;var c=function(e){if(!e){return;}var d=__ctx+"/platform/system/globalType/del.ht";var f={typeId:b};$.post(d,f,function(h){var g=a.getParentNode();if(g){reAsyncChild(g);}});};$.ligerDialog.confirm("此操作将删除改分类下所有的子节点，如果是数据字典分类字典数据也将删除，确认删除吗？","提示信息",c);}function getSelectNode(){glTypeTree=$.fn.zTree.getZTreeObj("glTypeTree");var a=glTypeTree.getSelectedNodes();var b=a[0];return b;}